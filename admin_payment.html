<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Payment Management - Academic Writing Hub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #004aad;
      --primary-light: #3a6fc8;
      --secondary: #ff6b35;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border: #e9ecef;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f4f6f9 0%, #e9ecef 100%);
      color: #333;
      line-height: 1.6;
    }

    header {
      background: var(--primary);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .header-left .slogan {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .user-menu:hover {
      background: var(--primary-light);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .container {
      display: flex;
      min-height: calc(100vh - 70px);
    }

    nav {
      width: 260px;
      background: #fff;
      border-right: 1px solid var(--border);
      padding: 20px 0;
      transition: transform 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }

    nav a {
      padding: 15px 25px;
      text-decoration: none;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    nav a:hover {
      background: var(--primary);
      color: #fff;
      border-left-color: var(--secondary);
    }

    nav a.active {
      background: var(--light);
      color: var(--primary);
      border-left-color: var(--primary);
      font-weight: 600;
    }

    main {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
    }

    .page-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,74,173,0.15);
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .page-header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      text-align: center;
      border-left: 4px solid var(--primary);
    }

    .stat-card.pending {
      border-left-color: var(--warning);
    }

    .stat-card.approved {
      border-left-color: var(--success);
    }

    .stat-card.rejected {
      border-left-color: var(--danger);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .stat-label {
      color: var(--gray);
      font-size: 14px;
      font-weight: 600;
    }

    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
    }

    .filter-group select, .filter-group input {
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .filter-group select:focus, .filter-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 74, 173, 0.2);
    }

    .payments-table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    .payments-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    .payments-table th,
    .payments-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .payments-table th {
      background: var(--light);
      font-weight: 600;
      color: var(--primary);
      position: sticky;
      top: 0;
    }

    .payment-row:hover {
      background: rgba(0, 74, 173, 0.05);
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 2px;
    }

    .action-btn.approve {
      background: var(--success);
      color: white;
    }

    .action-btn.approve:hover {
      background: #218838;
    }

    .action-btn.reject {
      background: var(--danger);
      color: white;
    }

    .action-btn.reject:hover {
      background: #c82333;
    }

    .action-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }

    .action-btn.view {
      background: var(--primary);
      color: white;
    }

    .action-btn.view:hover {
      background: var(--primary-light);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.info {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 10px;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 95%;
      max-width: 600px;
      max-height: 85vh;
      padding: 25px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: modalFade 0.3s;
      overflow-y: auto;
      margin: 20px auto;
    }

    @keyframes modalFade {
      from {opacity: 0; transform: translateY(-20px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      background: rgba(255,255,255,0.9);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .payment-details {
      margin-top: 20px;
    }

    .payment-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .payment-detail-row:last-child {
      border-bottom: none;
    }

    .payment-detail-label {
      font-weight: 600;
      color: var(--dark);
    }

    .payment-detail-value {
      color: var(--gray);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .modal-actions .approve-btn {
      background: var(--success);
      color: white;
    }

    .modal-actions .approve-btn:hover {
      background: #218838;
    }

    .modal-actions .reject-btn {
      background: var(--danger);
      color: white;
    }

    .modal-actions .reject-btn:hover {
      background: #c82333;
    }

    .notes-section {
      margin-top: 20px;
    }

    .notes-section textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
    }

    .notes-section textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Enhanced Mobile Responsive Styles */
    @media (max-width: 1024px) {
      .payments-table {
        min-width: 700px;
      }
    }

    @media (max-width: 768px) {
      .header-right .user-name {
        display: none;
      }

      .mobile-menu-btn {
        display: block;
      }

      nav {
        position: fixed;
        top: 70px;
        left: 0;
        height: calc(100vh - 70px);
        transform: translateX(-100%);
        z-index: 99;
        background: white;
        width: 280px;
      }

      nav.active {
        transform: translateX(0);
      }

      .admin-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-value {
        font-size: 28px;
      }

      .filter-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .payments-table-container {
        border-radius: 8px;
      }

      .payments-table {
        min-width: 600px;
        font-size: 14px;
      }

      .payments-table th,
      .payments-table td {
        padding: 12px 8px;
      }

      .modal-content {
        padding: 20px 15px;
        width: 98%;
        margin: 10px auto;
      }

      .payment-detail-row {
        flex-direction: column;
        gap: 5px;
        padding: 10px 0;
      }

      .payment-detail-label,
      .payment-detail-value {
        width: 100%;
      }

      .modal-actions {
        flex-direction: column;
      }

      .action-btn {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 10px;
        font-size: 14px;
      }
    }

    @media (max-width: 640px) {
      main {
        padding: 15px;
      }

      .page-header {
        padding: 20px 15px;
        margin-bottom: 20px;
      }

      .page-header h1 {
        font-size: 24px;
      }

      .page-header p {
        font-size: 14px;
      }

      .admin-stats {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 15px 12px;
      }

      .stat-value {
        font-size: 24px;
      }

      .stat-label {
        font-size: 12px;
      }

      .filter-section {
        padding: 15px;
      }

      .payments-table {
        min-width: 500px;
        font-size: 12px;
      }

      .payments-table th,
      .payments-table td {
        padding: 10px 6px;
      }

      .status-badge {
        font-size: 10px;
        padding: 4px 8px;
      }

      .modal-content {
        padding: 15px 12px;
      }

      .notes-section textarea {
        padding: 10px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      header {
        padding: 12px 15px;
      }

      .header-left h1 {
        font-size: 18px;
      }

      .header-left .slogan {
        font-size: 11px;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      main {
        padding: 12px;
      }

      .page-header {
        padding: 15px 12px;
      }

      .page-header h1 {
        font-size: 20px;
      }

      .admin-stats {
        gap: 10px;
      }

      .stat-card {
        padding: 12px 10px;
      }

      .stat-value {
        font-size: 22px;
      }

      .filter-section {
        padding: 12px;
      }

      .filter-group label {
        font-size: 13px;
      }

      .filter-group select, .filter-group input {
        padding: 8px 10px;
        font-size: 13px;
      }

      .payments-table {
        min-width: 450px;
        font-size: 11px;
      }

      .payments-table th,
      .payments-table td {
        padding: 8px 4px;
      }

      .modal-content {
        padding: 12px 10px;
      }

      .modal-actions button {
        padding: 10px;
        font-size: 14px;
      }
    }

    @media (max-width: 360px) {
      .header-left h1 {
        font-size: 16px;
      }

      .page-header h1 {
        font-size: 18px;
      }

      .stat-value {
        font-size: 20px;
      }

      .payments-table {
        min-width: 400px;
      }
    }

    /* Print Styles */
    @media print {
      .mobile-menu-btn,
      .filter-section,
      .action-btn {
        display: none !important;
      }

      .payments-table-container {
        box-shadow: none;
        border: 1px solid var(--border);
      }

      .payments-table {
        min-width: auto;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-left">
      <h1>Admin Panel - Payment Management</h1>
      <div class="slogan">Manage payments and deposit requests</div>
    </div>
    <div class="header-right">
      <div class="user-menu" id="userMenu">
        <div class="user-avatar" id="userAvatar">A</div>
        <span class="user-name" id="userName">Admin User</span>
      </div>
      <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>
    </div>
  </header>

  <div class="container">
    <nav id="sidebar">
      <a href="admin_dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="admin_payment.html" class="active"><i class="fas fa-credit-card"></i> Payment Management</a>
      <a href="admin_tasks.html"><i class="fas fa-tasks"></i> Task Management</a>
      <a href="admin_users.html"><i class="fas fa-users"></i> User Management</a>
      <a href="admin_withdrawals.html"><i class="fas fa-wallet"></i> Withdrawal Requests</a>
      <a href="admin_support.html"><i class="fas fa-headset"></i> Support Tickets</a>
      <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>

    <main>
      <div class="page-header">
        <h1>Payment Management</h1>
        <p>Review and manage payment requests for membership upgrades and deposits</p>
      </div>

      <div class="admin-stats">
        <div class="stat-card">
          <div class="stat-value" id="totalPayments">0</div>
          <div class="stat-label">Total Payments</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-value" id="pendingPayments">0</div>
          <div class="stat-label">Pending Review</div>
        </div>
        <div class="stat-card approved">
          <div class="stat-value" id="approvedPayments">0</div>
          <div class="stat-label">Approved</div>
        </div>
        <div class="stat-card rejected">
          <div class="stat-value" id="rejectedPayments">0</div>
          <div class="stat-label">Rejected</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-grid">
          <div class="filter-group">
            <label for="filterStatus">Payment Status</label>
            <select id="filterStatus">
              <option value="all">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterType">Payment Type</label>
            <select id="filterType">
              <option value="all">All Types</option>
              <option value="membership">Membership</option>
              <option value="deposit">Deposit</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterDate">Date Range</label>
            <input type="date" id="filterDate">
          </div>
          <div class="filter-group">
            <label for="searchPayments">Search</label>
            <input type="text" id="searchPayments" placeholder="Search by user or transaction ID">
          </div>
        </div>
      </div>

      <div id="messageContainer"></div>

      <div class="payments-table-container">
        <table class="payments-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Transaction ID</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 30px;">
                <span class="loading"></span> Loading payment requests...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Payment Details Modal -->
  <div class="modal" id="paymentModal">
    <div class="modal-content">
      <span class="close-modal" id="closeModal">&times;</span>
      <h2 style="color: var(--primary); margin-bottom: 20px;">Payment Details</h2>
      
      <div class="payment-details">
        <div class="payment-detail-row">
          <span class="payment-detail-label">User:</span>
          <span class="payment-detail-value" id="modalUserName">-</span>
        </div>
        <div class="payment-detail-row">
          <span class="payment-detail-label">Email:</span>
          <span class="payment-detail-value" id="modalUserEmail">-</span>
        </div>
        <div class="payment-detail-row">
          <span class="payment-detail-label">Payment Type:</span>
          <span class="payment-detail-value" id="modalPaymentType">-</span>
        </div>
        <div class="payment-detail-row">
          <span class="payment-detail-label">Package/Amount:</span>
          <span class="payment-detail-value" id="modalAmount">-</span>
        </div>
        <div class="payment-detail-row">
          <span class="payment-detail-label">Transaction ID:</span>
          <span class="payment-detail-value" id="modalTransactionId">-</span>
        </div>
        <div class="payment-detail-row">
          <span class="payment-detail-label">Date:</span>
          <span class="payment-detail-value" id="modalDate">-</span>
        </div>
        <div class="payment-detail-row">
          <span class="payment-detail-label">Status:</span>
          <span class="payment-detail-value" id="modalStatus">-</span>
        </div>
      </div>

      <div class="notes-section">
        <h3>Admin Notes</h3>
        <textarea id="adminNotes" placeholder="Add notes about this payment (optional)"></textarea>
      </div>

      <div class="modal-actions">
        <button class="approve-btn" id="approvePayment">Approve Payment</button>
        <button class="reject-btn" id="rejectPayment">Reject Payment</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = "https://lfrjtklkbppihaaiuxef.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmcmp0a2xrYnBwaWhhYWl1eGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTI5MzMsImV4cCI6MjA3NDYyODkzM30.2FVqnt5daF2Tw-RmVBwOGgt4GuIQQSkG8IUZt30QxIM";

    // Initialize Supabase client
    let supabaseClient;
    try {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (error) {
      console.error('Failed to initialize Supabase client:', error);
    }

    // Global variables
    let currentUser = null;
    let allPayments = [];
    let selectedPayment = null;

    // DOM Elements
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    const logoutBtn = document.getElementById('logoutBtn');
    const messageContainer = document.getElementById('messageContainer');
    const paymentModal = document.getElementById('paymentModal');
    const closeModal = document.getElementById('closeModal');
    const paymentsTableBody = document.getElementById('paymentsTableBody');
    const approvePaymentBtn = document.getElementById('approvePayment');
    const rejectPaymentBtn = document.getElementById('rejectPayment');
    const adminNotes = document.getElementById('adminNotes');
    const filterStatus = document.getElementById('filterStatus');
    const filterType = document.getElementById('filterType');
    const filterDate = document.getElementById('filterDate');
    const searchPayments = document.getElementById('searchPayments');

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    async function initializeApp() {
      // Set up event listeners
      setupEventListeners();
      
      // Check authentication
      await checkAuth();
      
      // Load payment data
      await loadPayments();
    }

    function setupEventListeners() {
      // Mobile menu toggle
      mobileMenuBtn.addEventListener('click', function() {
        sidebar.classList.toggle('active');
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target) && !e.target.closest('nav a')) {
          sidebar.classList.remove('active');
        }
      });

      // Close modal when clicking X
      closeModal.addEventListener('click', function() {
        paymentModal.style.display = 'none';
        selectedPayment = null;
        adminNotes.value = '';
      });

      // Close modal when clicking outside
      window.addEventListener('click', function(e) {
        if (e.target === paymentModal) {
          paymentModal.style.display = 'none';
          selectedPayment = null;
          adminNotes.value = '';
        }
      });

      // Approve payment
      approvePaymentBtn.addEventListener('click', handleApprovePayment);

      // Reject payment
      rejectPaymentBtn.addEventListener('click', handleRejectPayment);

      // Filter events
      filterStatus.addEventListener('change', filterPayments);
      filterType.addEventListener('change', filterPayments);
      filterDate.addEventListener('change', filterPayments);
      searchPayments.addEventListener('input', filterPayments);

      // Logout
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        handleLogout();
      });

      // Navigation links - prevent default and handle routing
      document.querySelectorAll('nav a').forEach(link => {
        if (link.id !== 'logoutBtn') {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            if (href && href !== '#') {
              window.location.href = href;
            }
          });
        }
      });
    }

    // Authentication check
    async function checkAuth() {
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (!session || error) {
          console.log("No session found, redirecting to login");
          window.location.href = "login.html";
          return;
        }
        
        currentUser = session.user;
        console.log("User authenticated:", currentUser.email);
        
        // Check if user has admin privileges (pro or premium role)
        const { data: profile, error: profileError } = await supabaseClient
          .from('profiles')
          .select('role, full_name')
          .eq('id', currentUser.id)
          .single();
          
        if (profileError) {
          console.error("Profile error:", profileError);
        } else if (profile) {
          // Update UI with admin name
          document.getElementById('userName').textContent = profile.full_name || 'Admin';
          document.getElementById('userAvatar').textContent = (profile.full_name || 'A').charAt(0).toUpperCase();
          
          // Check if user has admin access (pro or premium role)
          if (!['pro', 'premium'].includes(profile.role)) {
            console.log("User doesn't have admin access, redirecting to dashboard");
            window.location.href = "dashboard.html";
            return;
          }
        }

      } catch (error) {
        console.error("Auth error:", error);
        showMessage('Authentication error: ' + error.message, 'error');
      }
    }

    // Load all payment requests
    async function loadPayments() {
      try {
        let allPaymentData = [];

        // Load membership payment requests
        const { data: membershipPayments, error: membershipError } = await supabaseClient
          .from('payment_requests')
          .select('*')
          .order('created_at', { ascending: false });

        if (!membershipError && membershipPayments) {
          allPaymentData = allPaymentData.concat(membershipPayments.map(p => ({
            ...p,
            payment_type: 'membership',
            table_name: 'payment_requests'
          })));
        }

        // Load deposit requests
        const { data: depositPayments, error: depositError } = await supabaseClient
          .from('deposit_requests')
          .select('*')
          .order('created_at', { ascending: false });

        if (!depositError && depositPayments) {
          allPaymentData = allPaymentData.concat(depositPayments.map(p => ({
            ...p,
            payment_type: 'deposit',
            table_name: 'deposit_requests'
          })));
        }

        // If no data from database, use demo data
        if (allPaymentData.length === 0) {
          console.log("No payment data found, using demo data");
          allPaymentData = getDemoPayments();
        }

        allPayments = allPaymentData;

        // Update stats
        updateStats();
        
        // Render payments table
        renderPaymentsTable(allPayments);

      } catch (error) {
        console.error("Payments load error:", error);
        allPayments = getDemoPayments();
        updateStats();
        renderPaymentsTable(allPayments);
        showMessage('Using demo data. Database connection issue.', 'info');
      }
    }

    // Update statistics
    function updateStats() {
      const totalPayments = allPayments.length;
      const pendingPayments = allPayments.filter(p => p.status === 'pending').length;
      const approvedPayments = allPayments.filter(p => p.status === 'approved').length;
      const rejectedPayments = allPayments.filter(p => p.status === 'rejected').length;

      document.getElementById('totalPayments').textContent = totalPayments;
      document.getElementById('pendingPayments').textContent = pendingPayments;
      document.getElementById('approvedPayments').textContent = approvedPayments;
      document.getElementById('rejectedPayments').textContent = rejectedPayments;
    }

    // Render payments table
    function renderPaymentsTable(payments) {
      if (!payments || payments.length === 0) {
        paymentsTableBody.innerHTML = 
          '<tr>' +
            '<td colspan="7" style="text-align: center; padding: 30px; color: var(--gray);">' +
              'No payment requests found' +
            '</td>' +
          '</tr>';
        return;
      }

      paymentsTableBody.innerHTML = payments.map(payment => {
        // Get user info
        const userName = payment.user_email ? payment.user_email.split('@')[0] : 'Unknown User';
        const userEmail = payment.user_email || '-';
        
        // Format date
        const paymentDate = new Date(payment.created_at).toLocaleDateString();
        
        // Status badge
        let statusClass = 'status-pending';
        let statusText = 'Pending';
        
        if (payment.status === 'approved') {
          statusClass = 'status-approved';
          statusText = 'Approved';
        } else if (payment.status === 'rejected') {
          statusClass = 'status-rejected';
          statusText = 'Rejected';
        }
        
        // Format amount/package info
        let amountInfo = 'KSh ' + (payment.amount || 0).toLocaleString();
        if (payment.payment_type === 'membership' && payment.package) {
          amountInfo += ' (' + payment.package.charAt(0).toUpperCase() + payment.package.slice(1) + ')';
        }
        
        // Action buttons
        let actionButtons = '';
        if (payment.status === 'pending') {
          actionButtons = 
            '<button class="action-btn view" onclick="viewPaymentDetails(\'' + payment.id + '\')">View</button>' +
            '<button class="action-btn approve" onclick="approvePayment(\'' + payment.id + '\')">Approve</button>' +
            '<button class="action-btn reject" onclick="rejectPayment(\'' + payment.id + '\')">Reject</button>';
        } else {
          actionButtons = 
            '<button class="action-btn view" onclick="viewPaymentDetails(\'' + payment.id + '\')">View</button>';
        }
        
        return '<tr class="payment-row">' +
          '<td>' + 
            '<div><strong>' + userName + '</strong></div>' +
            '<div style="font-size: 12px; color: var(--gray);">' + userEmail + '</div>' +
          '</td>' +
          '<td>' + formatPaymentType(payment.payment_type) + '</td>' +
          '<td>' + amountInfo + '</td>' +
          '<td>' + (payment.transaction_id || '-') + '</td>' +
          '<td>' + paymentDate + '</td>' +
          '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>' +
          '<td style="white-space: nowrap;">' + actionButtons + '</td>' +
        '</tr>';
      }).join('');
    }

    // Filter payments based on criteria
    function filterPayments() {
      const statusFilter = filterStatus.value;
      const typeFilter = filterType.value;
      const dateFilter = filterDate.value;
      const searchFilter = searchPayments.value.toLowerCase();
      
      let filteredPayments = allPayments;
      
      // Apply status filter
      if (statusFilter !== 'all') {
        filteredPayments = filteredPayments.filter(p => p.status === statusFilter);
      }
      
      // Apply type filter
      if (typeFilter !== 'all') {
        filteredPayments = filteredPayments.filter(p => p.payment_type === typeFilter);
      }
      
      // Apply date filter
      if (dateFilter) {
        filteredPayments = filteredPayments.filter(p => {
          const paymentDate = new Date(p.created_at).toISOString().split('T')[0];
          return paymentDate === dateFilter;
        });
      }
      
      // Apply search filter
      if (searchFilter) {
        filteredPayments = filteredPayments.filter(p => {
          return (
            (p.user_email && p.user_email.toLowerCase().includes(searchFilter)) ||
            (p.transaction_id && p.transaction_id.toLowerCase().includes(searchFilter))
          );
        });
      }
      
      renderPaymentsTable(filteredPayments);
    }

    // Format payment type for display
    function formatPaymentType(type) {
      const types = {
        'membership': 'Membership',
        'deposit': 'Deposit'
      };
      
      return types[type] || type;
    }

    // View payment details
    function viewPaymentDetails(paymentId) {
      selectedPayment = allPayments.find(p => p.id === paymentId);
      
      if (!selectedPayment) {
        showMessage('Payment not found', 'error');
        return;
      }
      
      // Populate modal with payment details
      document.getElementById('modalUserName').textContent = selectedPayment.user_email ? selectedPayment.user_email.split('@')[0] : 'Unknown User';
      document.getElementById('modalUserEmail').textContent = selectedPayment.user_email || '-';
      document.getElementById('modalPaymentType').textContent = formatPaymentType(selectedPayment.payment_type);
      
      // Format amount info
      let amountInfo = 'KSh ' + (selectedPayment.amount || 0).toLocaleString();
      if (selectedPayment.payment_type === 'membership' && selectedPayment.package) {
        amountInfo += ' (' + selectedPayment.package.charAt(0).toUpperCase() + selectedPayment.package.slice(1) + ' Package)';
      }
      document.getElementById('modalAmount').textContent = amountInfo;
      
      document.getElementById('modalTransactionId').textContent = selectedPayment.transaction_id || '-';
      document.getElementById('modalDate').textContent = new Date(selectedPayment.created_at).toLocaleString();
      document.getElementById('modalStatus').textContent = selectedPayment.status.charAt(0).toUpperCase() + selectedPayment.status.slice(1);
      
      // Update action buttons based on status
      if (selectedPayment.status === 'pending') {
        approvePaymentBtn.disabled = false;
        rejectPaymentBtn.disabled = false;
        approvePaymentBtn.textContent = 'Approve Payment';
        rejectPaymentBtn.textContent = 'Reject Payment';
      } else {
        approvePaymentBtn.disabled = true;
        rejectPaymentBtn.disabled = true;
        approvePaymentBtn.textContent = selectedPayment.status === 'approved' ? 'Already Approved' : 'Cannot Approve';
        rejectPaymentBtn.textContent = selectedPayment.status === 'rejected' ? 'Already Rejected' : 'Cannot Reject';
      }
      
      // Reset notes
      adminNotes.value = selectedPayment.admin_notes || '';
      
      // Show modal
      paymentModal.style.display = 'flex';
    }

    // Approve payment (from table)
    function approvePayment(paymentId) {
      selectedPayment = allPayments.find(p => p.id === paymentId);
      if (selectedPayment) {
        viewPaymentDetails(paymentId);
      }
    }

    // Reject payment (from table)
    function rejectPayment(paymentId) {
      selectedPayment = allPayments.find(p => p.id === paymentId);
      if (selectedPayment) {
        handleRejectPayment();
      }
    }

    // Handle approve payment
    async function handleApprovePayment() {
      if (!selectedPayment) {
        showMessage('No payment selected', 'error');
        return;
      }
      
      // Show loading state
      approvePaymentBtn.innerHTML = '<span class="loading"></span> Approving...';
      approvePaymentBtn.disabled = true;
      rejectPaymentBtn.disabled = true;
      
      try {
        // Determine which table to update
        const tableName = selectedPayment.table_name || (selectedPayment.payment_type === 'deposit' ? 'deposit_requests' : 'payment_requests');
        
        // Update payment status in database
        const updateData = { 
          status: 'approved',
          admin_notes: adminNotes.value || null
        };
        
        // Add processed info
        if (tableName === 'payment_requests') {
          updateData.processed_at = new Date().toISOString();
          updateData.processed_by = currentUser.id;
        } else if (tableName === 'deposit_requests') {
          updateData.processed_at = new Date().toISOString();
          updateData.processed_by = currentUser.id;
        }
        
        const { data, error } = await supabaseClient
          .from(tableName)
          .update(updateData)
          .eq('id', selectedPayment.id);
        
        if (error) throw error;
        
        // Handle post-approval actions based on payment type
        if (selectedPayment.payment_type === 'membership') {
          await updateUserMembership(selectedPayment.user_id, selectedPayment.package);
        } else if (selectedPayment.payment_type === 'deposit') {
          await updateUserBalance(selectedPayment.user_id, selectedPayment.amount);
        }
        
        // Show success message
        showMessage('Payment approved successfully! User has been updated.', 'success');
        
        // Close modal
        paymentModal.style.display = 'none';
        
        // Reload payments
        await loadPayments();
        
      } catch (error) {
        console.error('Payment approval error:', error);
        showMessage('Failed to approve payment. Please try again.', 'error');
      } finally {
        // Reset button state
        approvePaymentBtn.innerHTML = 'Approve Payment';
        approvePaymentBtn.disabled = false;
        rejectPaymentBtn.disabled = false;
      }
    }

    // Handle reject payment
    async function handleRejectPayment() {
      if (!selectedPayment) {
        showMessage('No payment selected', 'error');
        return;
      }
      
      // Show loading state
      rejectPaymentBtn.innerHTML = '<span class="loading"></span> Rejecting...';
      approvePaymentBtn.disabled = true;
      rejectPaymentBtn.disabled = true;
      
      try {
        // Determine which table to update
        const tableName = selectedPayment.table_name || (selectedPayment.payment_type === 'deposit' ? 'deposit_requests' : 'payment_requests');
        
        const updateData = { 
          status: 'rejected',
          admin_notes: adminNotes.value || null
        };
        
        // Add processed info
        if (tableName === 'payment_requests') {
          updateData.processed_at = new Date().toISOString();
          updateData.processed_by = currentUser.id;
        } else if (tableName === 'deposit_requests') {
          updateData.processed_at = new Date().toISOString();
          updateData.processed_by = currentUser.id;
        }
        
        const { data, error } = await supabaseClient
          .from(tableName)
          .update(updateData)
          .eq('id', selectedPayment.id);
        
        if (error) throw error;
        
        // Show success message
        showMessage('Payment rejected successfully.', 'success');
        
        // Close modal
        paymentModal.style.display = 'none';
        
        // Reload payments
        await loadPayments();
        
      } catch (error) {
        console.error('Payment rejection error:', error);
        showMessage('Failed to reject payment. Please try again.', 'error');
      } finally {
        // Reset button state
        rejectPaymentBtn.innerHTML = 'Reject Payment';
        approvePaymentBtn.disabled = false;
        rejectPaymentBtn.disabled = false;
      }
    }

    // Update user membership
    async function updateUserMembership(userId, membershipLevel) {
      try {
        const { data, error } = await supabaseClient
          .from('profiles')
          .update({ 
            role: membershipLevel,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);
        
        if (error) throw error;
        
        console.log('Membership updated:', membershipLevel);
        
      } catch (error) {
        console.error('Membership update error:', error);
        throw error;
      }
    }

    // Update user balance for deposits - FIXED SYNTAX ERROR HERE
    async function updateUserBalance(userId, amount) {
      try {
        // First get current balance
        const { data: profile, error: fetchError } = await supabaseClient
          .from('profiles')
          .select('balance')
          .eq('id', userId)
          .single();
        
        if (fetchError) throw fetchError;
        
        const newBalance = (profile.balance || 0) + amount;
        
        const { data, error } = await supabaseClient
          .from('profiles')
          .update({ 
            balance: newBalance,
            updated_at: new Date().toISOString()  // FIXED: Changed = to : here
          })
          .eq('id', userId);
        
        if (error) throw error;
        
        console.log('Balance updated:', newBalance);
        
      } catch (error) {
        console.error('Balance update error:', error);
        throw error;
      }
    }

    // Show message
    function showMessage(message, type) {
      messageContainer.innerHTML = 
        '<div class="message ' + type + '">' +
          message +
        '</div>';
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(function() {
          messageContainer.innerHTML = '';
        }, 5000);
      }
    }

    // Logout function
    async function handleLogout() {
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = "login.html";
      } catch (error) {
        console.error("Logout error:", error);
        showMessage('Failed to logout', 'error');
      }
    }

    // Demo data for testing
    function getDemoPayments() {
      return [
        {
          id: '1',
          user_id: 'user1',
          user_email: 'john.doe@example.com',
          payment_type: 'membership',
          package: 'pro',
          amount: 5500,
          transaction_id: 'MPESA123456',
          status: 'pending',
          table_name: 'payment_requests',
          created_at: new Date().toISOString()
        },
        {
          id: '2',
          user_id: 'user2',
          user_email: 'jane.smith@example.com',
          payment_type: 'deposit',
          amount: 2500,
          transaction_id: 'MPESA789012',
          status: 'pending',
          table_name: 'deposit_requests',
          created_at: new Date(Date.now() - 86400000).toISOString()
        },
        {
          id: '3',
          user_id: 'user3',
          user_email: 'mike.johnson@example.com',
          payment_type: 'membership',
          package: 'starter',
          amount: 3500,
          transaction_id: 'MPESA345678',
          status: 'approved',
          table_name: 'payment_requests',
          created_at: new Date(Date.now() - 172800000).toISOString()
        },
        {
          id: '4',
          user_id: 'user4',
          user_email: 'sarah.wilson@example.com',
          payment_type: 'deposit',
          amount: 1000,
          transaction_id: 'MPESA901234',
          status: 'rejected',
          table_name: 'deposit_requests',
          created_at: new Date(Date.now() - 259200000).toISOString()
        }
      ];
    }

    // Make functions globally available
    window.viewPaymentDetails = viewPaymentDetails;
    window.approvePayment = approvePayment;
    window.rejectPayment = rejectPayment;
  </script>
</body>
</html>

