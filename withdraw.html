<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withdraw Earnings - Academic Writing Hub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* All your CSS styles remain exactly the same */
    :root { 
      --primary: #004aad; 
      --primary-light: #3a6fc8; 
      --secondary: #ff6b35; 
      --success: #28a745; 
      --warning: #ffc107; 
      --danger: #dc3545; 
      --light: #f8f9fa; 
      --dark: #343a40; 
      --gray: #6c757d; 
      --border: #e9ecef; 
      --gradient: linear-gradient(135deg, #004aad 0%, #3a6fc8 100%);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #f4f6f9 0%, #e9ecef 100%); 
      color: #333; 
      line-height: 1.6;
      min-height: 100vh;
    }
    
    header {
      background: var(--gradient);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }
    
    .header-left .slogan {
      font-size: 13px;
      opacity: .9;
      margin-top: 2px;
    }
    
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    .container {
      display: flex;
      min-height: calc(100vh - 70px);
    }
    
    nav {
      width: 260px;
      background: #fff;
      border-right: 1px solid var(--border);
      padding: 20px 0;
      transition: transform .3s ease;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
    }
    
    nav a {
      padding: 15px 25px;
      text-decoration: none;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all .3s;
      border-left: 3px solid transparent;
    }
    
    nav a:hover {
      background: var(--primary);
      color: #fff;
      border-left-color: var(--secondary);
    }
    
    nav a.active {
      background: var(--light);
      color: var(--primary);
      border-left-color: var(--primary);
      font-weight: 600;
    }
    
    main {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
    }
    
    .page-header {
      background: var(--gradient);
      color: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 74, 173, 0.15);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(30deg);
    }
    
    .page-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      position: relative;
    }
    
    .page-header p {
      opacity: .9;
      font-size: 16px;
      position: relative;
    }
    
    .balance-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      text-align: center;
      border-left: 4px solid var(--success);
      transition: transform 0.3s ease;
    }
    
    .balance-card:hover {
      transform: translateY(-5px);
    }
    
    .balance-amount {
      font-size: 42px;
      font-weight: 800;
      color: var(--success);
      margin: 10px 0;
    }
    
    .balance-label {
      color: var(--gray);
      font-size: 16px;
    }
    
    .withdrawal-rules {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
    }
    
    .rules-list {
      list-style: none;
      margin-top: 10px;
    }
    
    .rules-list li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .rules-list li::before {
      content: 'ðŸ“Œ';
      font-size: 14px;
    }
    
    .withdraw-form, .password-section, .withdrawal-history {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      transition: transform 0.3s ease;
    }
    
    .withdraw-form:hover, .password-section:hover, .withdrawal-history:hover {
      transform: translateY(-3px);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      transition: border-color .3s;
    }
    
    .form-group input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1);
    }
    
    .btn {
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all .3s ease;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 74, 173, .3);
    }
    
    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
    }
    
    .password-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .history-table th, .history-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .history-table th {
      background: var(--light);
      font-weight: 600;
      color: var(--primary);
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-paid {
      background: #d4edda;
      color: #155724;
    }
    
    .status-failed {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-processing {
      background: #cce7ff;
      color: #004085;
    }
    
    .message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message.info {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .section-title {
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .input-with-icon input {
      padding-left: 40px;
    }
    
    .tax-info {
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .tax-breakdown {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .tax-breakdown div {
      text-align: center;
      flex: 1;
    }
    
    .tax-breakdown .amount {
      font-weight: 600;
      font-size: 16px;
      margin-top: 5px;
    }
    
    /* New styles for amount buttons */
    .amount-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    
    .amount-btn {
      background: white;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .amount-btn:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .amount-btn.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0, 74, 173, 0.3);
    }
    
    .selected-amount-display {
      background: var(--light);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
      color: var(--primary);
    }
    
    @media (max-width: 768px) {
      .mobile-menu-btn { display: block; }
      
      nav {
        position: fixed;
        top: 70px;
        left: 0;
        height: calc(100vh - 70px);
        transform: translateX(-100%);
        z-index: 99;
        background: white;
      }
      
      nav.active { transform: translateX(0); }
      
      .password-form { grid-template-columns: 1fr; }
      
      .history-table { font-size: 14px; }
      
      .history-table th, .history-table td { padding: 8px; }
      
      .balance-amount { font-size: 32px; }
      
      .tax-breakdown { flex-direction: column; gap: 10px; }
      
      .amount-options { grid-template-columns: repeat(3, 1fr); }
    }
    
    @media (max-width: 480px) {
      .amount-options { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-left">
      <h1>Academic Writing Hub</h1>
      <div class="slogan">Empowering Your Potential Through Academic Writing</div>
    </div>
    <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>
  </header>

  <div class="container">
    <nav id="sidebar">
      <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
      <a href="membership.html"><i class="fas fa-credit-card"></i> Membership</a>
      <a href="tasks.html"><i class="fas fa-tasks"></i> Tasks</a>
      <a href="withdraw.html" class="active"><i class="fas fa-money-bill-wave"></i> Withdraw</a>
      <a href="referrals.html"><i class="fas fa-users"></i> Referrals</a>
      <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
      <a href="support.html"><i class="fas fa-envelope"></i> Support</a>
      <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>

    <main>
      <div class="page-header">
        <h1><i class="fas fa-money-bill-wave"></i> Withdraw Earnings</h1>
        <!-- CHANGED: Updated description -->
        <p>Request withdrawal of your earnings to your M-Pesa account (Available 24/7)</p>
      </div>

      <div class="balance-card">
        <div class="balance-label">Available Balance</div>
        <!-- CHANGED: Changed from KSh to USD -->
        <div class="balance-amount" id="balanceAmount">$0.00</div>
        <div class="balance-label" id="withdrawableInfo">Select an amount to withdraw</div>
      </div>

      <div class="withdrawal-rules">
        <h3 style="color: #856404; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Withdrawal Rules</h3>
        <ul class="rules-list">
          <li>10% transaction tax applies to all withdrawals</li>
          <!-- CHANGED: Removed Wednesday/Friday restriction -->
          <li>Withdrawals processed <strong>24/7</strong> (Available every day)</li>
          <li>Processing time: 24-48 hours after approval</li>
          <li>Ensure your M-Pesa number is registered in your name</li>
          <li>Withdrawal password required for security</li>
          <!-- CHANGED: Updated to daily limit -->
          <li><strong>Maximum one withdrawal per day</strong></li>
        </ul>
      </div>

      <div id="messageContainer"></div>

      <div class="withdraw-form">
        <h3 class="section-title"><i class="fas fa-wallet"></i> Request Withdrawal</h3>
        
        <div class="form-group">
          <!-- CHANGED: Label to USD -->
          <label>Select Amount (USD)</label>
          <div class="amount-options" id="amountOptions">
            <!-- CHANGED: All amounts converted to USD (1 USD = 129 KSh) -->
            <button type="button" class="amount-btn" data-amount="3.88">$3.88 â‰ˆ KSh 500</button>
            <button type="button" class="amount-btn" data-amount="11.63">$11.63 â‰ˆ KSh 1,500</button>
            <button type="button" class="amount-btn" data-amount="15.50">$15.50 â‰ˆ KSh 2,000</button>
            <button type="button" class="amount-btn" data-amount="19.38">$19.38 â‰ˆ KSh 2,500</button>
            <button type="button" class="amount-btn" data-amount="23.26">$23.26 â‰ˆ KSh 3,000</button>
            <button type="button" class="amount-btn" data-amount="27.13">$27.13 â‰ˆ KSh 3,500</button>
            <button type="button" class="amount-btn" data-amount="31.01">$31.01 â‰ˆ KSh 4,000</button>
            <button type="button" class="amount-btn" data-amount="34.88">$34.88 â‰ˆ KSh 4,500</button>
            <button type="button" class="amount-btn" data-amount="62.02">$62.02 â‰ˆ KSh 8,000</button>
            <button type="button" class="amount-btn" data-amount="93.02">$93.02 â‰ˆ KSh 12,000</button>
            <button type="button" class="amount-btn" data-amount="116.28">$116.28 â‰ˆ KSh 15,000</button>
            <button type="button" class="amount-btn" data-amount="155.04">$155.04 â‰ˆ KSh 20,000</button>
            <button type="button" class="amount-btn" data-amount="232.56">$232.56 â‰ˆ KSh 30,000</button>
            <button type="button" class="amount-btn" data-amount="310.08">$310.08 â‰ˆ KSh 40,000</button>
            <button type="button" class="amount-btn" data-amount="387.60">$387.60 â‰ˆ KSh 50,000</button>
          </div>
        </div>
        
        <div class="selected-amount-display" id="selectedAmountDisplay" style="display: none;">
          <!-- CHANGED: Changed from KSh to USD -->
          Selected Amount: <span id="selectedAmount">$0</span>
        </div>
        
        <div id="taxCalculation" style="display: none;">
          <div class="tax-info">
            <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary);">
              <i class="fas fa-calculator"></i> Tax Calculation (10%)
            </div>
            <div class="tax-breakdown">
              <div>
                <div>Requested Amount</div>
                <!-- CHANGED: Changed from KSh to USD -->
                <div class="amount" id="requestedAmount">$0</div>
              </div>
              <div>
                <div>Tax (10%)</div>
                <!-- CHANGED: Changed from KSh to USD -->
                <div class="amount" id="taxAmount">$0</div>
              </div>
              <div>
                <div>You Receive</div>
                <!-- CHANGED: Changed from KSh to USD -->
                <div class="amount" id="netAmount">$0</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="withdrawMpesa">M-Pesa Number</label>
          <div class="input-with-icon">
            <i class="fas fa-mobile-alt input-icon"></i>
            <input type="text" id="withdrawMpesa" placeholder="e.g., 0712 345 678" maxlength="10">
          </div>
        </div>
        <div class="form-group">
          <label for="withdrawPassword">Withdrawal Password</label>
          <div class="input-with-icon">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="withdrawPassword" placeholder="Enter your 6-digit withdrawal password" maxlength="6">
          </div>
        </div>
        <button class="btn btn-primary" id="withdrawBtn">
          <i class="fas fa-paper-plane"></i> Submit Withdrawal Request
        </button>
      </div>

      <div class="password-section">
        <h3 class="section-title"><i class="fas fa-key"></i> Change Withdrawal Password</h3>
        <div class="password-form">
          <div class="form-group">
            <label for="oldWithdrawPassword">Current Password</label>
            <div class="input-with-icon">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="oldWithdrawPassword" placeholder="Current password" maxlength="6">
            </div>
          </div>
          <div class="form-group">
            <label for="newWithdrawPassword">New Password</label>
            <div class="input-with-icon">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="newWithdrawPassword" placeholder="New password (6 digits)" maxlength="6">
            </div>
          </div>
          <div class="form-group">
            <label for="confirmWithdrawPassword">Confirm New Password</label>
            <div class="input-with-icon">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="confirmWithdrawPassword" placeholder="Confirm new password" maxlength="6">
            </div>
          </div>
        </div>
        <button class="btn btn-primary" id="passwordBtn">
          <i class="fas fa-sync-alt"></i> Update Password
        </button>
      </div>

      <div class="withdrawal-history">
        <h3 class="section-title"><i class="fas fa-history"></i> Withdrawal History</h3>
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <!-- CHANGED: Changed from Amount to Amount (USD) -->
              <th>Amount (USD)</th>
              <th>M-Pesa</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="withdrawalHistory">
            <tr>
              <td colspan="4" style="text-align:center;padding:30px;color:var(--gray);">
                <span class="loading"></span> Loading withdrawal history...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = "https://lfrjtklkbppihaaiuxef.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmcmp0a2xrYnBwaWhhYWl1eGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTI5MzMsImV4cCI6MjA3NDYyODkzM30.2FVqnt5daF2Tw-RmVBwOGgt4GuIQQSkG8IUZt30QxIM";

    // Initialize Supabase client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ADDED: Conversion rate (1 USD = 129 KSh)
    const USD_TO_KSH_RATE = 129;
    const KSH_TO_USD_RATE = 1 / USD_TO_KSH_RATE;

    let currentUser = null;
    let userProfile = null;
    let selectedAmount = 0; // This will now be in USD

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    async function initializeApp() {
        setupEventListeners();
        await checkAuth();
    }

    function setupEventListeners() {
        // Mobile menu
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            if (sidebar && mobileMenuBtn && !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });

        // Withdraw button
        const withdrawBtn = document.getElementById('withdrawBtn');
        if (withdrawBtn) {
            withdrawBtn.addEventListener('click', handleWithdrawal);
        }

        // Change password button
        const passwordBtn = document.getElementById('passwordBtn');
        if (passwordBtn) {
            passwordBtn.addEventListener('click', changeWithdrawPassword);
        }

        // Amount buttons
        const amountButtons = document.querySelectorAll('.amount-btn');
        amountButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // Remove selected class from all buttons
                amountButtons.forEach(function(btn) {
                    btn.classList.remove('selected');
                });
                
                // Add selected class to clicked button
                this.classList.add('selected');
                
                // Set selected amount (in USD)
                selectedAmount = parseFloat(this.getAttribute('data-amount'));
                
                // Update UI
                updateSelectedAmountDisplay();
                calculateTax();
            });
        });

        // Logout
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
        }
    }

    // ADDED: Helper function to convert KSh to USD
    function kshToUsd(kshAmount) {
        return (kshAmount * KSH_TO_USD_RATE).toFixed(2);
    }

    // ADDED: Helper function to convert USD to KSh
    function usdToKsh(usdAmount) {
        return (usdAmount * USD_TO_KSH_RATE).toFixed(0);
    }

    // ADDED: Format USD currency
    function formatUSD(amount) {
        return '$' + parseFloat(amount).toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function updateSelectedAmountDisplay() {
        const selectedAmountDisplay = document.getElementById('selectedAmountDisplay');
        const selectedAmountSpan = document.getElementById('selectedAmount');
        
        if (selectedAmountDisplay && selectedAmountSpan) {
            // CHANGED: Show USD amount
            selectedAmountSpan.textContent = formatUSD(selectedAmount);
            selectedAmountDisplay.style.display = 'block';
        }
    }

    function calculateTax() {
        const amount = selectedAmount || 0;
        const taxCalculation = document.getElementById('taxCalculation');
        
        if (amount > 0) {
            const tax = amount * 0.10;
            const netAmount = amount - tax;
            
            // CHANGED: Show USD amounts
            document.getElementById('requestedAmount').textContent = formatUSD(amount);
            document.getElementById('taxAmount').textContent = formatUSD(tax);
            document.getElementById('netAmount').textContent = formatUSD(netAmount);
            
            taxCalculation.style.display = 'block';
        } else {
            taxCalculation.style.display = 'none';
        }
    }

    // CHANGED: Always return true for withdrawals 24/7
    function isWithdrawalDay() {
        return true; // Withdrawals available every day
    }

    // Function to get today's date string in YYYY-MM-DD format
    function getTodayDateString() {
        const today = new Date();
        return today.toISOString().split('T')[0];
    }

    // Function to check if user has already withdrawn today
    async function hasWithdrawnToday() {
        try {
            const today = getTodayDateString();
            
            const { data: withdrawals, error } = await supabaseClient
                .from('withdrawals')
                .select('created_at')
                .eq('user_id', currentUser.id)
                .gte('created_at', today + 'T00:00:00')
                .lte('created_at', today + 'T23:59:59');

            if (error) throw error;
            
            return withdrawals && withdrawals.length > 0;
        } catch (error) {
            console.error('Error checking today withdrawals:', error);
            return false;
        }
    }

    async function checkAuth() {
        try {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error || !session) {
                window.location.href = "login.html";
                return;
            }

            currentUser = session.user;
            await loadUserData();

        } catch (error) {
            console.error('Auth check error:', error);
            window.location.href = "login.html";
        }
    }

    async function loadUserData() {
        try {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (error) throw error;

            userProfile = profile;
            updateUI(profile);
            await loadWithdrawalHistory();
            await subscribeToWithdrawalUpdates();

        } catch (error) {
            console.error('User data load error:', error);
            showMessage('Failed to load user data: ' + error.message, 'error');
        }
    }

    function updateUI(profile) {
        const balanceAmount = document.getElementById('balanceAmount');
        if (balanceAmount) {
            const balanceKSH = parseFloat(profile.balance) || 0;
            // CHANGED: Convert KSh balance to USD for display
            const balanceUSD = kshToUsd(balanceKSH);
            balanceAmount.textContent = formatUSD(balanceUSD);
        }
        
        const infoElement = document.getElementById('withdrawableInfo');
        if (infoElement) {
            const currentBalanceKSH = parseFloat(profile.balance) || 0;
            const currentBalanceUSD = kshToUsd(currentBalanceKSH);
            const isTodayWithdrawalDay = isWithdrawalDay();
            
            // CHANGED: Minimum amount in USD (500 KSh = 3.88 USD)
            const minWithdrawalUSD = 3.88;
            
            if (currentBalanceUSD >= minWithdrawalUSD && isTodayWithdrawalDay) {
                // CHANGED: Show USD amounts
                infoElement.innerHTML = 'Select an amount to withdraw (Maximum: ' + formatUSD(Math.min(currentBalanceUSD, 387.60)) + ')';
                infoElement.style.color = 'var(--success)';
            } else if (!isTodayWithdrawalDay) {
                // This should never happen now, but keeping as fallback
                infoElement.innerHTML = 'Withdrawals available 24/7';
                infoElement.style.color = 'var(--warning)';
            } else {
                infoElement.innerHTML = 'You need at least ' + formatUSD(minWithdrawalUSD) + ' to withdraw';
                infoElement.style.color = 'var(--danger)';
            }
        }
        
        const mpesaField = document.getElementById('withdrawMpesa');
        if (mpesaField && profile.phone) {
            mpesaField.value = profile.phone;
        }
    }

    async function handleWithdrawal() {
        const mpesaInput = document.getElementById('withdrawMpesa');
        const passwordInput = document.getElementById('withdrawPassword');
        const withdrawBtn = document.getElementById('withdrawBtn');

        const amountUSD = selectedAmount; // User selects USD amount
        const mpesaNumber = mpesaInput.value.trim().replace(/\s/g, '');
        const password = passwordInput.value.trim();
        const currentBalanceKSH = parseFloat(userProfile.balance) || 0;
        const currentBalanceUSD = kshToUsd(currentBalanceKSH);

        // CHANGED: Always allow withdrawals (removed day check)
        // Validation - Check if user has already withdrawn today
        const hasWithdrawn = await hasWithdrawnToday();
        if (hasWithdrawn) {
            showMessage('You have already made a withdrawal today. Only one withdrawal is allowed per day.', 'error');
            return;
        }

        // Validation
        // CHANGED: Minimum amount in USD (3.88 USD = 500 KSh)
        if (!amountUSD || amountUSD < 3.88) {
            showMessage('Minimum withdrawal amount is $3.88', 'error');
            return;
        }

        // CHANGED: Maximum amount in USD (387.60 USD = 50,000 KSh)
        if (amountUSD > 387.60) {
            showMessage('Maximum withdrawal amount is $387.60 per transaction', 'error');
            return;
        }

        if (!mpesaNumber || mpesaNumber.length !== 10 || isNaN(mpesaNumber)) {
            showMessage('Please enter a valid 10-digit M-Pesa number', 'error');
            return;
        }

        if (!password || password.length !== 6) {
            showMessage('Please enter your 6-digit withdrawal password', 'error');
            return;
        }

        // CHANGED: Check balance in USD
        if (amountUSD > currentBalanceUSD) {
            showMessage('Insufficient balance. You need ' + formatUSD(amountUSD) + ' to withdraw ' + formatUSD(amountUSD - (amountUSD * 0.10)) + ' after tax', 'error');
            return;
        }

        const userPassword = userProfile.withdraw_password || '123456';
        if (password !== userPassword) {
            showMessage('Invalid withdrawal password', 'error');
            return;
        }

        try {
            withdrawBtn.innerHTML = '<span class="loading"></span> Processing...';
            withdrawBtn.disabled = true;

            const taxAmountUSD = amountUSD * 0.10;
            const netAmountUSD = amountUSD - taxAmountUSD;
            
            // Convert to KSh for database storage
            const amountKSH = usdToKsh(amountUSD);
            const taxAmountKSH = usdToKsh(taxAmountUSD);
            const netAmountKSH = usdToKsh(netAmountUSD);

            // Create withdrawal request
            const { error } = await supabaseClient
                .from('withdrawals')
                .insert([
                    {
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        amount: parseFloat(netAmountKSH), // Store in KSh
                        original_amount: parseFloat(amountKSH), // Store in KSh
                        tax_amount: parseFloat(taxAmountKSH), // Store in KSh
                        mpesa_number: mpesaNumber,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    }
                ]);

            if (error) throw error;

            // Only deduct the withdrawal amount from balance (in KSh)
            const newBalanceKSH = currentBalanceKSH - parseFloat(amountKSH);
            const { error: updateError } = await supabaseClient
                .from('profiles')
                .update({ balance: newBalanceKSH })
                .eq('id', currentUser.id);

            if (updateError) throw updateError;

            userProfile.balance = newBalanceKSH;
            updateUI(userProfile);

            // Clear form
            selectedAmount = 0;
            passwordInput.value = '';
            document.getElementById('taxCalculation').style.display = 'none';
            document.getElementById('selectedAmountDisplay').style.display = 'none';
            
            // Clear selected button
            const selectedButton = document.querySelector('.amount-btn.selected');
            if (selectedButton) {
                selectedButton.classList.remove('selected');
            }

            // CHANGED: Show amounts in USD
            showMessage('Withdrawal request submitted successfully! ' + formatUSD(taxAmountUSD) + ' tax deducted. Net amount: ' + formatUSD(netAmountUSD), 'success');
            
            await loadWithdrawalHistory();

        } catch (error) {
            console.error('Withdrawal error:', error);
            showMessage('Failed to process withdrawal: ' + error.message, 'error');
        } finally {
            if (withdrawBtn) {
                withdrawBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Withdrawal Request';
                withdrawBtn.disabled = false;
            }
        }
    }

    async function changeWithdrawPassword() {
        const oldPasswordInput = document.getElementById('oldWithdrawPassword');
        const newPasswordInput = document.getElementById('newWithdrawPassword');
        const confirmPasswordInput = document.getElementById('confirmWithdrawPassword');
        const passwordBtn = document.getElementById('passwordBtn');

        const oldPassword = oldPasswordInput.value.trim();
        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();

        if (!oldPassword) {
            showMessage('Please enter your current password', 'error');
            return;
        }

        if (!newPassword || newPassword.length !== 6) {
            showMessage('New password must be exactly 6 digits', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            showMessage('New passwords do not match', 'error');
            return;
        }

        const userPassword = userProfile.withdraw_password || '123456';
        if (oldPassword !== userPassword) {
            showMessage('Current password is incorrect', 'error');
            return;
        }

        try {
            passwordBtn.innerHTML = '<span class="loading"></span> Updating...';
            passwordBtn.disabled = true;

            const { error } = await supabaseClient
                .from('profiles')
                .update({ withdraw_password: newPassword })
                .eq('id', currentUser.id);

            if (error) throw error;

            userProfile.withdraw_password = newPassword;

            oldPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';

            showMessage('Withdrawal password updated successfully!', 'success');

        } catch (error) {
            console.error('Password change error:', error);
            showMessage('Failed to update password: ' + error.message, 'error');
        } finally {
            if (passwordBtn) {
                passwordBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Password';
                passwordBtn.disabled = false;
            }
        }
    }

    async function loadWithdrawalHistory() {
        try {
            const { data: withdrawals, error } = await supabaseClient
                .from('withdrawals')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) throw error;

            const historyBody = document.getElementById('withdrawalHistory');
            if (!historyBody) return;
            
            if (!withdrawals || withdrawals.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:var(--gray);">No withdrawal history found</td></tr>';
                return;
            }

            historyBody.innerHTML = withdrawals.map(function(withdrawal) {
                const date = new Date(withdrawal.created_at).toLocaleDateString();
                // CHANGED: Convert KSh amount from database to USD for display
                const amountKSH = parseFloat(withdrawal.amount) || 0;
                const amountUSD = kshToUsd(amountKSH);
                const mpesa = withdrawal.mpesa_number || '-';
                
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                
                if (withdrawal.status === 'completed' || withdrawal.status === 'paid' || withdrawal.status === 'approved') {
                    statusClass = 'status-paid';
                    statusText = 'Paid';
                } else if (withdrawal.status === 'cancelled' || withdrawal.status === 'rejected' || withdrawal.status === 'failed') {
                    statusClass = 'status-failed';
                    statusText = 'Failed to withdraw';
                } else if (withdrawal.status === 'processing') {
                    statusClass = 'status-processing';
                    statusText = 'Processing';
                }

                // CHANGED: Show amount in USD
                return '<tr><td>' + date + '</td><td>' + formatUSD(amountUSD) + '</td><td>' + mpesa + '</td><td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td></tr>';
            }).join('');

        } catch (error) {
            console.error('History load error:', error);
            const historyBody = document.getElementById('withdrawalHistory');
            if (historyBody) {
                historyBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:var(--danger);">Failed to load withdrawal history</td></tr>';
            }
        }
    }

    async function subscribeToWithdrawalUpdates() {
        try {
            const subscription = supabaseClient
                .channel('withdrawal-updates')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'withdrawals',
                        filter: 'user_id=eq.' + currentUser.id
                    },
                    function(payload) {
                        loadWithdrawalHistory();
                    }
                )
                .subscribe();

            return subscription;

        } catch (error) {
            console.error('Error setting up real-time subscription:', error);
        }
    }

    function showMessage(message, type) {
        const messageContainer = document.getElementById('messageContainer');
        if (!messageContainer) return;
        
        messageContainer.innerHTML = '<div class="message ' + type + '">' + message + '</div>';
        
        if (type === 'success') {
            setTimeout(function() {
                if (messageContainer) {
                    messageContainer.innerHTML = '';
                }
            }, 5000);
        }
    }

    async function handleLogout() {
        try {
            const { error } = await supabaseClient.auth.signOut();
            if (error) throw error;
            window.location.href = "login.html";
        } catch (error) {
            console.error("Logout error:", error);
            showMessage('Failed to logout', 'error');
        }
    }

    // Auth state listener
    supabaseClient.auth.onAuthStateChange(function(event, session) {
        if (event === 'SIGNED_OUT') {
            window.location.href = "login.html";
        }
    });
  </script>
</body>
</html>

