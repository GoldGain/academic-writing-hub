<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Gold Gain Academic Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #004aad; --primary-light: #3a6fc8; --primary-dark: #003580;
            --secondary: #ff6b35; --success: #28a745; --warning: #ffc107;
            --danger: #dc3545; --light: #f8f9fa; --dark: #343a40;
            --gray: #6c757d; --border: #dee2e6; --shadow: rgba(0,0,0,0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #333; line-height: 1.6; min-height: 100vh; }
        
        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-box h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 800;
        }
        
        .login-box p {
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .login-form input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,74,173,0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,74,173,0.3);
        }
        
        /* Admin Panel Styles */
        .admin-panel {
            display: none;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100;
            border-bottom: 3px solid var(--secondary);
        }
        
        .header-left h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .header-left .slogan { font-size: 13px; opacity: 0.9; margin-top: 4px; font-weight: 500; }
        
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-menu { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: all 0.3s; background: rgba(255,255,255,0.1); }
        .user-menu:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--secondary), #ff8c42); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 16px; box-shadow: 0 4px 10px rgba(255,107,53,0.3); }
        .mobile-menu-btn { display: none; background: none; border: none; color: white; font-size: 22px; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.3s; }
        .mobile-menu-btn:hover { background: rgba(255,255,255,0.1); }
        
        .container { display: flex; min-height: calc(100vh - 70px); }
        
        nav {
            width: 280px; background: linear-gradient(180deg, #fff 0%, #f8f9fa 100%); border-right: 1px solid var(--border);
            padding: 25px 0; transition: transform 0.3s ease; box-shadow: 3px 0 15px rgba(0,0,0,0.08);
            display: flex; flex-direction: column;
        }
        
        nav a {
            padding: 16px 28px; text-decoration: none; color: var(--dark);
            display: flex; align-items: center; gap: 15px; transition: all 0.3s;
            border-left: 4px solid transparent; font-weight: 500; margin: 2px 10px;
            border-radius: 0 12px 12px 0;
        }
        
        nav a:hover { background: linear-gradient(135deg, var(--primary-light), var(--primary)); color: #fff; border-left-color: var(--secondary); transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,74,173,0.2); }
        nav a.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; border-left-color: var(--secondary); font-weight: 600; box-shadow: 0 4px 12px rgba(0,74,173,0.25); }
        
        main { flex: 1; padding: 30px; overflow-y: auto; background: transparent; }
        
        .page-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,74,173,0.2);
            margin-bottom: 30px; position: relative; overflow: hidden;
        }
        
        .page-header::before {
            content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(30deg);
        }
        
        .page-header h1 { font-size: 32px; margin-bottom: 10px; font-weight: 800; position: relative; }
        .page-header p { opacity: 0.95; font-size: 17px; font-weight: 400; position: relative; max-width: 600px; }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 35px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            text-align: center;
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.15); }
        
        .stat-card.pending { border-left-color: var(--warning); }
        .stat-card.pending::before { background: linear-gradient(90deg, var(--warning), #ffd54f); }
        .stat-card.approved { border-left-color: var(--success); }
        .stat-card.approved::before { background: linear-gradient(90deg, var(--success), #34ce57); }
        .stat-card.rejected { border-left-color: var(--danger); }
        .stat-card.rejected::before { background: linear-gradient(90deg, var(--danger), #e35d6a); }
        .stat-card.earnings { border-left-color: var(--secondary); }
        .stat-card.earnings::before { background: linear-gradient(90deg, var(--secondary), #ff8c42); }
        
        .stat-value { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
        .stat-card.pending .stat-value { color: var(--warning); }
        .stat-card.approved .stat-value { color: var(--success); }
        .stat-card.rejected .stat-value { color: var(--danger); }
        .stat-card.earnings .stat-value { color: var(--secondary); }
        .stat-label { color: var(--gray); font-size: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 35px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .section h3 {
            color: var(--primary);
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 3px solid var(--border);
            padding-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 14px 26px;
            background: none;
            border: none;
            border-bottom: 4px solid transparent;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 10px 10px 0 0;
            font-size: 15px;
            position: relative;
        }
        
        .tab-btn:hover { color: var(--primary); background: rgba(0,74,173,0.05); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(0,74,173,0.08); font-weight: 700; }
        
        .btn {
            padding: 14px 22px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before { left: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 4px 12px rgba(0,74,173,0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, var(--primary-light), var(--primary)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,74,173,0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success), #34ce57); color: white; box-shadow: 0 4px 12px rgba(40,167,69,0.3); }
        .btn-success:hover { background: linear-gradient(135deg, #34ce57, var(--success)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(40,167,69,0.4); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #e35d6a); color: white; box-shadow: 0 4px 12px rgba(220,53,69,0.3); }
        .btn-danger:hover { background: linear-gradient(135deg, #e35d6a, var(--danger)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220,53,69,0.4); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #ffd54f); color: var(--dark); box-shadow: 0 4px 12px rgba(255,193,7,0.3); }
        .btn-warning:hover { background: linear-gradient(135deg, #ffd54f, var(--warning)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255,193,7,0.4); }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:hover { transform: none; box-shadow: none; }
        .btn:disabled::before { display: none; }
        
        .submission-card {
            background: white;
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            border-top: 5px solid var(--warning);
        }
        
        .submission-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--warning), #ffd54f);
        }
        
        .submission-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        
        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
        }
        
        .task-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .task-type {
            display: inline-block;
            padding: 6px 14px;
            background: var(--light);
            color: var(--primary);
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            border: 1px solid rgba(0,74,173,0.1);
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
            padding-top: 18px;
            border-top: 2px solid var(--border);
        }
        
        .user-info {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .user-contact {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            margin-bottom: 15px;
        }
        
        .user-balance {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--success);
            margin-bottom: 15px;
            font-weight: 700;
            color: #155724;
        }
        
        .submission-content {
            background: var(--light);
            padding: 25px;
            border-radius: 12px;
            margin: 18px 0;
            white-space: pre-wrap;
            font-size: 15px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border);
        }
        
        .audio-player {
            width: 100%;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .transcription-info {
            background: linear-gradient(135deg, #e7f3ff, #d4e7ff);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid var(--primary);
        }
        
        .quality-metrics {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid var(--warning);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 13px;
            color: var(--gray);
            font-weight: 600;
        }
        
        .metric-good { color: var(--success); }
        .metric-warning { color: var(--warning); }
        .metric-danger { color: var(--danger); }
        
        .admin-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }
        
        .reject-form {
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 12px;
            display: none;
            border: 2px solid var(--warning);
        }
        
        .reject-form textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
            font-family: inherit;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,74,173,0.1);
        }
        
        .file-upload-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: rgba(248,249,250,0.5);
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary);
            background: rgba(0,74,173,0.03);
        }
        
        .file-upload-area.dragover {
            border-color: var(--primary);
            background: var(--light);
            transform: scale(1.02);
        }
        
        .uploaded-files {
            margin-top: 20px;
        }
        
        .file-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .message {
            padding: 18px;
            border-radius: 12px;
            margin: 18px 0;
            text-align: center;
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .message.success { background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; border: 1px solid #b1dfbb; }
        .message.error { background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; border: 1px solid #f1b0b7; }
        .message.info { background: linear-gradient(135deg, #cce7ff, #b3d7ff); color: #004085; border: 1px solid #9ec5fe; }
        .message.warning { background: linear-gradient(135deg, #fff3cd, #ffeaa7); color: #856404; border: 1px solid #ffeaa7; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 70px 25px;
            color: var(--gray);
        }
        
        .no-data h3 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 22px;
            font-weight: 700;
        }
        
        .no-data p {
            font-size: 16px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .task-type-badge {
            display: inline-block;
            padding: 6px 14px;
            background: var(--primary);
            color: white;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            margin-left: 10px;
        }
        
        .task-type-badge.transcription { background: #17a2b8; }
        .task-type-badge.academic_writing { background: var(--success); }
        .task-type-badge.data_entry { background: var(--warning); color: var(--dark); }
        .task-type-badge.content_writing { background: var(--primary-light); }
        .task-type-badge.academic_research { background: #6f42c1; }
        
        .time-taken {
            background: linear-gradient(135deg, #e7f3ff, #d4e7ff);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .header-left h1 { font-size: 20px; }
            .header-right .user-name { display: none; }
            .mobile-menu-btn { display: block; }
            
            nav { 
                position: fixed; 
                top: 70px; 
                left: 0; 
                height: calc(100vh - 70px); 
                transform: translateX(-100%); 
                z-index: 99; 
                background: white; 
                width: 280px; 
            }
            
            nav.active { transform: translateX(0); }
            
            main { padding: 20px 15px; }
            
            .page-header { padding: 25px 20px; }
            .page-header h1 { font-size: 26px; }
            
            .admin-stats { grid-template-columns: 1fr; gap: 15px; }
            .stat-card { padding: 20px; }
            .stat-value { font-size: 28px; }
            
            .section { padding: 20px; }
            .section h3 { font-size: 20px; }
            
            .tabs { gap: 8px; }
            .tab-btn { padding: 12px 18px; font-size: 14px; }
            
            .submission-card { padding: 20px; }
            .submission-header { flex-direction: column; gap: 15px; }
            .task-title { font-size: 18px; }
            
            .admin-actions { flex-direction: column; }
            .btn { width: 100%; }
            
            .metric-grid { grid-template-columns: 1fr; }
            
            .form-group { margin-bottom: 15px; }
            
            .file-upload-area { padding: 30px 20px; }
            
            .user-contact { font-size: 13px; padding: 10px; }
            
            .submission-content { padding: 15px; max-height: 300px; }
        }
        
        @media (max-width: 480px) {
            .login-box { padding: 30px 20px; }
            .page-header h1 { font-size: 22px; }
            .section h3 { font-size: 18px; }
            .task-title { font-size: 16px; }
            .stat-value { font-size: 24px; }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div class="login-container" id="loginSection">
        <div class="login-box">
            <h1>üîê Admin Login</h1>
            <p>Enter your admin password to access the dashboard</p>
            <form class="login-form" id="loginForm">
                <input type="password" id="adminPassword" placeholder="Enter Admin Password" required>
                <button type="submit" class="login-btn">Access Admin Panel</button>
            </form>
            <div id="loginMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Admin Panel (Initially Hidden) -->
    <div class="admin-panel" id="adminPanel">
        <header>
            <div class="header-left">
                <h1>Gold Gain Academic Hub - Admin</h1>
                <div class="slogan">Complete Task Management System</div>
            </div>
            <div class="header-right">
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span class="user-name" id="userName">Admin</span>
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
            </div>
        </header>

        <div class="container">
            <nav id="sidebar">
                <a href="#" class="active" data-tab="dashboard">üìä Dashboard</a>
                <a href="#" data-tab="review-tasks">üëë Review Tasks</a>
                <a href="#" data-tab="create-task">‚ûï Create Task</a>
                <a href="#" data-tab="upload-audio">üéß Upload Audio</a>
                <a href="#" data-tab="user-management">üë• User Management</a>
                <a href="#" id="logoutBtn">üö™ Logout</a>
            </nav>

            <main>
                <!-- Dashboard Section -->
                <div class="section" id="dashboard">
                    <div class="page-header">
                        <h1>üìä Admin Dashboard</h1>
                        <p>Complete overview of task submissions, approvals, and system statistics</p>
                    </div>

                    <div class="admin-stats" id="adminStats">
                        <div class="stat-card pending">
                            <div class="stat-value" id="pendingCount">0</div>
                            <div class="stat-label">Pending Review</div>
                        </div>
                        <div class="stat-card approved">
                            <div class="stat-value" id="approvedCount">0</div>
                            <div class="stat-label">Approved Today</div>
                        </div>
                        <div class="stat-card rejected">
                            <div class="stat-value" id="rejectedCount">0</div>
                            <div class="stat-label">Rejected Today</div>
                        </div>
                        <div class="stat-card earnings">
                            <div class="stat-value" id="totalEarnings">KSh 0</div>
                            <div class="stat-label">Total Paid Out</div>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üìà Recent Activity</h3>
                        <div id="recentActivity">
                            <div class="no-data">
                                <h3>Loading recent activity...</h3>
                                <p><span class="loading"></span> Please wait</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Tasks Section -->
                <div class="section" id="review-tasks" style="display: none;">
                    <div class="page-header">
                        <h1>üëë Task Review Panel</h1>
                        <p>Review submitted tasks with advanced quality assessment tools</p>
                    </div>

                    <div id="messageContainer"></div>
                    <div id="submissionsContainer">
                        <div class="no-data">
                            <h3>üì≠ Loading submissions...</h3>
                            <p><span class="loading"></span> Please wait while we load the submissions</p>
                        </div>
                    </div>
                </div>

                <!-- Create Task Section -->
                <div class="section" id="create-task" style="display: none;">
                    <div class="page-header">
                        <h1>‚ûï Create New Task</h1>
                        <p>Create new tasks for users to complete with detailed requirements</p>
                    </div>

                    <form id="createTaskForm">
                        <div class="form-group">
                            <label for="taskTitle">Task Title</label>
                            <input type="text" id="taskTitle" placeholder="Enter task title" required>
                        </div>

                        <div class="form-group">
                            <label for="taskType">Task Type</label>
                            <select id="taskType" required>
                                <option value="">Select task type</option>
                                <option value="academic_writing">Academic Writing</option>
                                <option value="academic_research">Academic Research</option>
                                <option value="content_writing">Content Writing</option>
                                <option value="data_entry">Data Entry</option>
                                <option value="transcription">Audio Transcription</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="taskDescription">Task Description</label>
                            <textarea id="taskDescription" placeholder="Describe the task in detail..." rows="4" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="taskRequirements">Requirements (one per line)</label>
                            <textarea id="taskRequirements" placeholder="Enter each requirement on a new line..." rows="4"></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="rewardAmount">Reward Amount (KSh)</label>
                                <input type="number" id="rewardAmount" placeholder="e.g., 500" min="0" required>
                            </div>

                            <div class="form-group">
                                <label for="taskDifficulty">Difficulty Level</label>
                                <select id="taskDifficulty" required>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="requiredMembership">Required Membership</label>
                                <select id="requiredMembership" required>
                                    <option value="starter">Starter</option>
                                    <option value="pro">Pro</option>
                                    <option value="premium">Premium</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="deadlineDays">Deadline (Days)</label>
                                <input type="number" id="deadlineDays" placeholder="e.g., 7" min="1" required>
                            </div>
                        </div>

                        <!-- Transcription-specific fields -->
                        <div id="transcriptionFields" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label for="wordCountTarget">Target Word Count</label>
                                    <input type="number" id="wordCountTarget" placeholder="e.g., 1000" min="0">
                                </div>

                                <div class="form-group">
                                    <label for="audioDuration">Audio Duration (seconds)</label>
                                    <input type="number" id="audioDuration" placeholder="e.g., 3600" min="0">
                                </div>
                            </div>
                            
                            <!-- Audio URL field for transcription tasks -->
                            <div class="form-group">
                                <label for="audioUrl">üîó Audio File URL</label>
                                <input type="url" id="audioUrl" placeholder="https://your-bucket.supabase.co/storage/v1/object/public/audio-files/your-file.mp3" class="form-control">
                                <small style="display: block; margin-top: 5px; color: var(--gray); font-size: 13px;">
                                    After uploading to Supabase Storage, paste the public URL here
                                </small>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                Create Task
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Upload Audio Section -->
                <div class="section" id="upload-audio" style="display: none;">
                    <div class="page-header">
                        <h1>üéß Upload Audio Files</h1>
                        <p>Upload audio files to Supabase Storage for transcription tasks</p>
                    </div>

                    <div class="section">
                        <h3>üìÅ Step 1: Upload to Supabase Storage</h3>
                        <div style="background: linear-gradient(135deg, #e7f3ff, #d4e7ff); padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px;">How to Upload Audio:</h4>
                            <ol style="padding-left: 20px; line-height: 1.8;">
                                <li>Go to your <strong>Supabase Dashboard</strong> ‚Üí Storage</li>
                                <li>Create a bucket named <code>audio-files</code> (set to Public)</li>
                                <li>Click on the bucket and upload your audio files</li>
                                <li>After upload, copy the <strong>Public URL</strong> of each file</li>
                                <li>Paste the URL in the "Audio File URL" field when creating tasks</li>
                            </ol>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üîó Step 2: Link Audio URL to Task</h3>
                        <form id="linkAudioForm">
                            <div class="form-group">
                                <label for="audioUrlInput">Audio File URL</label>
                                <input type="url" id="audioUrlInput" placeholder="https://your-bucket.supabase.co/storage/v1/object/public/audio-files/your-file.mp3" required>
                                <small style="display: block; margin-top: 5px; color: var(--gray); font-size: 13px;">
                                    Paste the Supabase Storage public URL here
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="taskSelect">Select Task to Link</label>
                                <select id="taskSelect" required>
                                    <option value="">Select a transcription task</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <button type="submit" class="btn btn-success" style="width: 100%;">
                                    üîó Link Audio URL to Task
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- User Management Section -->
                <div class="section" id="user-management" style="display: none;">
                    <div class="page-header">
                        <h1>üë• User Management</h1>
                        <p>Manage users, view statistics, and handle user accounts</p>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" data-user-tab="all-users">All Users</button>
                        <button class="tab-btn" data-user-tab="top-earners">Top Earners</button>
                        <button class="tab-btn" data-user-tab="recent-activity">Recent Activity</button>
                    </div>

                    <div id="usersContainer">
                        <div class="no-data">
                            <h3>Loading users...</h3>
                            <p><span class="loading"></span> Please wait while we load user data</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://lfrjtklkbppihaaiuxef.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmcmp0a2xrYnBwaWhhYWl1eGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTI5MzMsImV4cCI6MjA3NDYyODkzM30.2FVqnt5daF2Tw-RmVBwOGgt4GuIQQSkG8IUZt30QxIM";

        // Admin password
        const ADMIN_PASSWORD = "89269248";

        // Initialize Supabase client
        let supabaseClient;
        try {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized successfully');
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
        }

        // Global variables
        let currentAdmin = null;
        let allTasks = [];
        let allUsers = {};
        let allSubmissions = [];
        let isProcessing = {};

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const adminPanel = document.getElementById('adminPanel');
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const logoutBtn = document.getElementById('logoutBtn');
        const messageContainer = document.getElementById('messageContainer');
        const submissionsContainer = document.getElementById('submissionsContainer');
        const createTaskForm = document.getElementById('createTaskForm');
        const taskTypeSelect = document.getElementById('taskType');
        const transcriptionFields = document.getElementById('transcriptionFields');
        const linkAudioForm = document.getElementById('linkAudioForm');
        const taskSelect = document.getElementById('taskSelect');

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            checkExistingSession();
        }

        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', handleLogin);

            // Mobile menu
            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            });

            // Navigation
            document.querySelectorAll('nav a[data-tab]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('data-tab'));
                    sidebar.classList.remove('active');
                });
            });

            // User management tabs
            document.querySelectorAll('.tab-btn[data-user-tab]').forEach(btn => {
                btn.addEventListener('click', function() {
                    showUserTab(this.getAttribute('data-user-tab'));
                });
            });

            // Logout
            logoutBtn.addEventListener('click', handleLogout);

            // Task type change
            taskTypeSelect.addEventListener('change', function() {
                if (this.value === 'transcription') {
                    transcriptionFields.style.display = 'block';
                } else {
                    transcriptionFields.style.display = 'none';
                }
            });

            // Create task form
            createTaskForm.addEventListener('submit', handleCreateTask);

            // Link audio form
            linkAudioForm.addEventListener('submit', handleLinkAudio);
        }

        function checkExistingSession() {
            const adminSession = localStorage.getItem('adminSession');
            if (adminSession === 'true') {
                showAdminPanel();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;

            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminSession', 'true');
                showAdminPanel();
            } else {
                showLoginMessage('‚ùå Invalid password. Please try again.', 'error');
            }
        }

        function showLoginMessage(message, type) {
            loginMessage.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        function showAdminPanel() {
            loginSection.style.display = 'none';
            adminPanel.style.display = 'block';
            loadAdminData();
        }

        function handleLogout() {
            localStorage.removeItem('adminSession');
            loginSection.style.display = 'flex';
            adminPanel.style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav links
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section and set active nav link
            document.getElementById(sectionName).style.display = 'block';
            document.querySelector(`nav a[data-tab="${sectionName}"]`).classList.add('active');

            // Load section-specific data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'review-tasks':
                    loadSubmissions();
                    // Auto-scroll to top when opening review tasks
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                    break;
                case 'create-task':
                    break;
                case 'upload-audio':
                    loadTasksForLinking();
                    break;
                case 'user-management':
                    loadUsers();
                    break;
            }
        }

        function showUserTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn[data-user-tab]').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to clicked tab
            document.querySelector(`.tab-btn[data-user-tab="${tabName}"]`).classList.add('active');

            // Load tab-specific data
            switch(tabName) {
                case 'all-users':
                    renderAllUsers();
                    break;
                case 'top-earners':
                    renderTopEarners();
                    break;
                case 'recent-activity':
                    renderRecentActivity();
                    break;
            }
        }

        async function loadAdminData() {
            try {
                await Promise.all([
                    loadDashboardData(),
                    loadTasks(),
                    loadUsersData()
                ]);
            } catch (error) {
                console.error('Error loading admin data:', error);
                showMessage('Failed to load admin data', 'error');
            }
        }

        async function loadDashboardData() {
            try {
                // Load REAL pending submissions count
                const { data: pendingData, error: pendingError } = await supabaseClient
                    .from('user_tasks')
                    .select('id')
                    .eq('status', 'submitted');

                if (!pendingError) {
                    document.getElementById('pendingCount').textContent = pendingData?.length || 0;
                } else {
                    console.error('Error loading pending count:', pendingError);
                    document.getElementById('pendingCount').textContent = '0';
                }

                // Load REAL today's approved count and earnings
                const today = new Date().toISOString().split('T')[0];
                const { data: approvedData, error: approvedError } = await supabaseClient
                    .from('user_tasks')
                    .select('id, paid_amount, completed_at')
                    .eq('status', 'approved');

                if (!approvedError) {
                    // Filter today's data manually
                    const todayApproved = approvedData?.filter(task => {
                        const taskDate = new Date(task.completed_at).toISOString().split('T')[0];
                        return taskDate === today;
                    }) || [];
                    
                    document.getElementById('approvedCount').textContent = todayApproved.length;
                    
                    // Calculate REAL total earnings from today
                    const totalEarnings = todayApproved.reduce((sum, task) => sum + (task.paid_amount || 0), 0);
                    document.getElementById('totalEarnings').textContent = 'KSh ' + totalEarnings.toLocaleString();
                } else {
                    console.error('Error loading approved count:', approvedError);
                    document.getElementById('approvedCount').textContent = '0';
                    document.getElementById('totalEarnings').textContent = 'KSh 0';
                }

                // Load REAL today's rejected count
                const { data: rejectedData, error: rejectedError } = await supabaseClient
                    .from('user_tasks')
                    .select('id, admin_reviewed_at')
                    .eq('status', 'rejected');

                if (!rejectedError) {
                    // Filter today's data manually
                    const todayRejected = rejectedData?.filter(task => {
                        const taskDate = new Date(task.admin_reviewed_at).toISOString().split('T')[0];
                        return taskDate === today;
                    }) || [];
                    
                    document.getElementById('rejectedCount').textContent = todayRejected.length;
                } else {
                    console.error('Error loading rejected count:', rejectedError);
                    document.getElementById('rejectedCount').textContent = '0';
                }

                // Load recent activity
                await loadRecentActivity();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Set all to 0 if there's an error
                document.getElementById('pendingCount').textContent = '0';
                document.getElementById('approvedCount').textContent = '0';
                document.getElementById('rejectedCount').textContent = '0';
                document.getElementById('totalEarnings').textContent = 'KSh 0';
            }
        }

        async function loadRecentActivity() {
            try {
                // Get all user_tasks and manually join with other tables
                const { data: userTasks, error } = await supabaseClient
                    .from('user_tasks')
                    .select('*')
                    .in('status', ['approved', 'rejected', 'submitted'])
                    .order('submitted_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const activityContainer = document.getElementById('recentActivity');
                
                if (!userTasks || userTasks.length === 0) {
                    activityContainer.innerHTML = `
                        <div class="no-data">
                            <h3>No recent activity</h3>
                            <p>Activity will appear here as tasks are submitted and reviewed</p>
                        </div>
                    `;
                    return;
                }

                // Manually join data since relationships are not working
                const activityWithDetails = await Promise.all(
                    userTasks.map(async (task) => {
                        // Get task details
                        const { data: taskData } = await supabaseClient
                            .from('tasks')
                            .select('title')
                            .eq('id', task.task_id)
                            .single();

                        // Get user details
                        const { data: userData } = await supabaseClient
                            .from('profiles')
                            .select('full_name, email')
                            .eq('id', task.user_id)
                            .single();

                        return {
                            ...task,
                            task_title: taskData?.title || 'Unknown Task',
                            user_name: userData?.full_name || 'Unknown User',
                            user_email: userData?.email || 'No email'
                        };
                    })
                );

                activityContainer.innerHTML = activityWithDetails.map(item => {
                    const statusIcon = {
                        'submitted': 'üü°',
                        'approved': '‚úÖ',
                        'rejected': '‚ùå'
                    }[item.status];

                    const statusColor = {
                        'submitted': 'warning',
                        'approved': 'success',
                        'rejected': 'danger'
                    }[item.status];

                    return `
                        <div class="submission-card">
                            <div class="submission-header">
                                <div style="flex: 1;">
                                    <div class="task-title">${item.task_title}</div>
                                    <div class="user-info">
                                        <strong>User:</strong> ${item.user_name} | 
                                        <strong>Status:</strong> <span class="task-type-badge ${statusColor}">${statusIcon} ${item.status.toUpperCase()}</span> | 
                                        <strong>Time:</strong> ${new Date(item.submitted_at).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                            ${item.admin_feedback ? `<div class="user-contact"><strong>Admin Feedback:</strong> ${item.admin_feedback}</div>` : ''}
                            ${item.paid_amount ? `<div class="user-balance"><strong>Amount Paid:</strong> KSh ${item.paid_amount}</div>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <div class="no-data">
                        <h3>Error loading activity</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        async function loadTasks() {
            try {
                const { data: tasks, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .eq('status', 'active');

                if (error) throw error;
                allTasks = tasks || [];
                console.log('Loaded tasks:', allTasks.length);
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        async function loadUsersData() {
            try {
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('*');

                if (error) throw error;
                
                // Convert array to object for easy lookup
                allUsers = {};
                users.forEach(user => {
                    allUsers[user.id] = user;
                });
                console.log('Loaded users:', Object.keys(allUsers).length);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadSubmissions() {
            try {
                showMessage('Loading submissions...', 'info');
                
                // FIXED: Get submissions with latest first and proper column names
                const { data: submissions, error } = await supabaseClient
                    .from('user_tasks')
                    .select('*')
                    .eq('status', 'submitted')
                    .order('submitted_at', { ascending: false }); // LATEST FIRST

                if (error) throw error;
                
                allSubmissions = submissions || [];
                
                // Manually join with tasks and users data
                const submissionsWithDetails = await Promise.all(
                    allSubmissions.map(async (submission) => {
                        const task = allTasks.find(t => t.id === submission.task_id) || 
                                   await getTaskDetails(submission.task_id);
                        const user = allUsers[submission.user_id] || 
                                   await getUserDetails(submission.user_id);
                        
                        return {
                            ...submission,
                            task,
                            user
                        };
                    })
                );
                
                renderSubmissions(submissionsWithDetails);
                
                // Auto-scroll to top after loading submissions
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 300);
                
            } catch (error) {
                console.error('Error loading submissions:', error);
                showMessage('Failed to load submissions: ' + error.message, 'error');
            }
        }

        async function getTaskDetails(taskId) {
            try {
                const { data: task, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .eq('id', taskId)
                    .single();
                
                return task || { 
                    title: 'Unknown Task', 
                    task_type: 'unknown', 
                    reward_amount: 0,
                    description: 'No description available',
                    requirements: 'No requirements specified'
                };
            } catch (error) {
                console.error('Error loading task details:', error);
                return { 
                    title: 'Unknown Task', 
                    task_type: 'unknown', 
                    reward_amount: 0,
                    description: 'No description available',
                    requirements: 'No requirements specified'
                };
            }
        }

        async function getUserDetails(userId) {
            try {
                const { data: user, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                return user || { 
                    full_name: 'Unknown User', 
                    email: 'No email', 
                    phone: 'No phone', 
                    balance: 0, 
                    tasks_completed: 0, 
                    total_earnings: 0 
                };
            } catch (error) {
                console.error('Error loading user details:', error);
                return { 
                    full_name: 'Unknown User', 
                    email: 'No email', 
                    phone: 'No phone', 
                    balance: 0, 
                    tasks_completed: 0, 
                    total_earnings: 0 
                };
            }
        }

        function renderSubmissions(submissions) {
            if (!submissions || submissions.length === 0) {
                submissionsContainer.innerHTML = `
                    <div class="no-data">
                        <h3>üéâ No Submissions to Review</h3>
                        <p>All caught up! No tasks are waiting for review.</p>
                    </div>
                `;
                return;
            }

            submissionsContainer.innerHTML = submissions.map(submission => {
                const task = submission.task;
                const user = submission.user;

                // FIXED: Get submission data from the correct columns
                const submissionData = submission.work_data || submission.submission_data || '';
                const submittedContent = submission.submitted_content || '';
                
                // Extract content from work_data if it's an object
                let content = '';
                if (typeof submissionData === 'object' && submissionData !== null) {
                    content = submissionData.content || submissionData.transcription || JSON.stringify(submissionData, null, 2);
                } else if (submissionData) {
                    content = submissionData;
                } else if (submittedContent) {
                    content = submittedContent;
                }

                const wordAnalysis = analyzeWordCount(content, task.word_count_target);
                const timeTaken = submission.time_spent ? formatTimeTaken(submission.time_spent) : 'Not recorded';
                const userBalance = user?.balance || 0;

                return `
                    <div class="submission-card" id="submission-${submission.id}">
                        <div class="submission-header">
                            <div style="flex: 1;">
                                <div class="task-title">
                                    ${task.title || 'No Title'}
                                    <span class="task-type-badge ${task.task_type}">${formatTaskType(task.task_type)}</span>
                                </div>
                                <div class="user-info">
                                    <strong>User:</strong> ${user ? (user.full_name || 'No Name') : 'Unknown User'} | 
                                    <strong>Submitted:</strong> ${new Date(submission.submitted_at).toLocaleString()}
                                </div>
                                <div class="user-contact">
                                    <strong>üìß Email:</strong> ${user?.email || 'Not available'} | 
                                    <strong>üìû Phone:</strong> ${user?.phone || 'Not provided'}
                                </div>
                                <div class="user-balance">
                                    <strong>üí∞ Current Balance:</strong> KSh ${userBalance.toLocaleString()} | 
                                    <strong>üìä Tasks Completed:</strong> ${user?.tasks_completed || 0} | 
                                    <strong>üíµ Total Earnings:</strong> KSh ${(user?.total_earnings || 0).toLocaleString()}
                                </div>
                            </div>
                            <div class="reward-amount">
                                KSh ${task.reward_amount || '0'}
                            </div>
                        </div>

                        ${task.task_type === 'transcription' ? `
                            <div class="transcription-info">
                                <strong>üéß Transcription Task</strong>
                                ${task.audio_duration ? `<br><small>Audio Duration: ${formatAudioDuration(task.audio_duration)}</small>` : ''}
                                ${task.word_count_target ? `<br><small>Target Words: ${task.word_count_target}</small>` : ''}
                                ${task.audio_url ? `
                                    <br>
                                    <audio controls class="audio-player">
                                        <source src="${task.audio_url}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                    </audio>
                                    <br><small><a href="${task.audio_url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">üîó Direct Audio Link</a></small>
                                ` : ''}
                            </div>
                        ` : ''}

                        <div class="time-taken">
                            <strong>‚è±Ô∏è Time Taken:</strong> ${timeTaken}
                        </div>

                        <div class="quality-metrics">
                            <h4>üìä Quality Assessment</h4>
                            <div class="metric-grid">
                                <div class="metric-item">
                                    <div class="metric-value ${wordAnalysis.qualityColor}">${wordAnalysis.words}</div>
                                    <div class="metric-label">Words</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${wordAnalysis.characters}</div>
                                    <div class="metric-label">Characters</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${wordAnalysis.sentences}</div>
                                    <div class="metric-label">Sentences</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${wordAnalysis.avgSentenceLength.toFixed(1)}</div>
                                    <div class="metric-label">Avg. Sentence Length</div>
                                </div>
                            </div>
                            ${task.word_count_target ? `
                                <div style="margin-top: 10px; text-align: center;">
                                    <strong>Word Count Status:</strong> 
                                    <span class="${wordAnalysis.qualityColor}" style="font-weight: 700;">
                                        ${wordAnalysis.quality.toUpperCase()}
                                    </span>
                                    (${((wordAnalysis.words / task.word_count_target) * 100).toFixed(1)}% of target)
                                </div>
                            ` : ''}
                        </div>

                        <div class="submission-content">
                            ${content || 'No content submitted'}
                        </div>

                        <div class="admin-actions">
                            <button class="btn btn-success" id="approve-btn-${submission.id}" 
                                onclick="approveTask('${submission.id}', '${submission.task_id}', '${submission.user_id}', ${task.reward_amount || 0})"
                                ${isProcessing[submission.id] ? 'disabled' : ''}>
                                ${isProcessing[submission.id] ? '<span class="loading"></span> Processing...' : '‚úÖ Approve & Pay'}
                            </button>
                            <button class="btn btn-danger" id="reject-btn-${submission.id}" 
                                onclick="showRejectForm('${submission.id}')"
                                ${isProcessing[submission.id] ? 'disabled' : ''}>
                                ‚ùå Reject
                            </button>
                        </div>

                        <div class="reject-form" id="reject-form-${submission.id}">
                            <textarea id="feedback-${submission.id}" placeholder="Provide constructive feedback for rejection..."></textarea>
                            <button class="btn btn-warning" onclick="rejectTask('${submission.id}')">Submit Rejection</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // FIXED: Fully functional approveTask function that updates user_tasks properly
        async function approveTask(userTaskId, taskId, userId, rewardAmount) {
            if (isProcessing[userTaskId]) {
                showMessage('This task is already being processed', 'warning');
                return;
            }

            try {
                isProcessing[userTaskId] = true;
                
                const approveBtn = document.getElementById(`approve-btn-${userTaskId}`);
                const rejectBtn = document.getElementById(`reject-btn-${userTaskId}`);
                
                if (approveBtn) {
                    approveBtn.innerHTML = '<span class="loading"></span> Processing...';
                    approveBtn.disabled = true;
                }
                if (rejectBtn) rejectBtn.disabled = true;

                showMessage('Approving task and processing payment...', 'info');

                // First, get the current user data to know their current balance
                const { data: userData, error: userError } = await supabaseClient
                    .from('profiles')
                    .select('balance, tasks_completed, total_earnings')
                    .eq('id', userId)
                    .single();

                if (userError) {
                    console.error('Error fetching user data:', userError);
                    throw userError;
                }

                const currentBalance = userData?.balance || 0;
                const currentTasksCompleted = userData?.tasks_completed || 0;
                const currentTotalEarnings = userData?.total_earnings || 0;

                // Calculate new values
                const newBalance = parseFloat(currentBalance) + parseFloat(rewardAmount);
                const newTasksCompleted = parseInt(currentTasksCompleted) + 1;
                const newTotalEarnings = parseFloat(currentTotalEarnings) + parseFloat(rewardAmount);

                // CRITICAL FIX: Update user_tasks table with ALL required fields
                const { error: taskUpdateError } = await supabaseClient
                    .from('user_tasks')
                    .update({
                        status: 'approved',
                        completed_at: new Date().toISOString(),
                        paid_amount: parseFloat(rewardAmount),
                        admin_reviewed_at: new Date().toISOString()
                    })
                    .eq('id', userTaskId);

                if (taskUpdateError) {
                    console.error('Task update error:', taskUpdateError);
                    throw taskUpdateError;
                }

                // Update user profile with new balance and stats
                const { error: profileUpdateError } = await supabaseClient
                    .from('profiles')
                    .update({
                        balance: newBalance,
                        tasks_completed: newTasksCompleted,
                        total_earnings: newTotalEarnings
                    })
                    .eq('id', userId);

                if (profileUpdateError) {
                    console.error('Profile update error:', profileUpdateError);
                    throw profileUpdateError;
                }

                console.log(`Task ${userTaskId} approved successfully for user ${userId}`);
                console.log(`User balance updated from ${currentBalance} to ${newBalance}`);
                console.log(`Tasks completed: ${newTasksCompleted}, Total earnings: ${newTotalEarnings}`);

                // Remove from local data array
                allSubmissions = allSubmissions.filter(sub => sub.id !== userTaskId);
                
                // Remove from UI
                const submissionElement = document.getElementById(`submission-${userTaskId}`);
                if (submissionElement) {
                    submissionElement.remove();
                }
                
                showMessage(`‚úÖ Task approved! User rewarded KSh ${rewardAmount}. New balance: KSh ${newBalance.toLocaleString()}`, 'success');

                // Update dashboard with REAL data
                await loadDashboardData();

            } catch (error) {
                console.error('Approval error:', error);
                showMessage('‚ùå Failed to approve task: ' + error.message, 'error');
                
                // Reset buttons
                const approveBtn = document.getElementById(`approve-btn-${userTaskId}`);
                const rejectBtn = document.getElementById(`reject-btn-${userTaskId}`);
                if (approveBtn) {
                    approveBtn.innerHTML = '‚úÖ Approve & Pay';
                    approveBtn.disabled = false;
                }
                if (rejectBtn) rejectBtn.disabled = false;
            } finally {
                isProcessing[userTaskId] = false;
            }
        }

        function showRejectForm(userTaskId) {
            const form = document.getElementById(`reject-form-${userTaskId}`);
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        // FIXED: Fully functional rejectTask function that updates user_tasks properly
        async function rejectTask(userTaskId) {
            if (isProcessing[userTaskId]) {
                showMessage('This task is already being processed', 'warning');
                return;
            }

            const feedback = document.getElementById(`feedback-${userTaskId}`).value.trim();
            
            if (!feedback) {
                showMessage('Please provide rejection feedback', 'error');
                return;
            }

            try {
                isProcessing[userTaskId] = true;
                
                const approveBtn = document.getElementById(`approve-btn-${userTaskId}`);
                const rejectBtn = document.getElementById(`reject-btn-${userTaskId}`);
                if (approveBtn) approveBtn.disabled = true;
                if (rejectBtn) rejectBtn.disabled = true;

                // CRITICAL FIX: Update user_tasks table with ALL required fields
                const { error } = await supabaseClient
                    .from('user_tasks')
                    .update({
                        status: 'rejected',
                        admin_feedback: feedback,
                        admin_reviewed_at: new Date().toISOString(),
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', userTaskId);

                if (error) {
                    console.error('Rejection update error:', error);
                    throw error;
                }

                console.log(`Task ${userTaskId} rejected successfully`);

                // Remove from local data array
                allSubmissions = allSubmissions.filter(sub => sub.id !== userTaskId);
                
                // Remove from UI
                const submissionElement = document.getElementById(`submission-${userTaskId}`);
                if (submissionElement) {
                    submissionElement.remove();
                }
                
                showMessage('‚úÖ Task rejected with feedback provided', 'success');
                await loadDashboardData();

            } catch (error) {
                console.error('Rejection error:', error);
                showMessage('‚ùå Failed to reject task: ' + error.message, 'error');
            } finally {
                isProcessing[userTaskId] = false;
            }
        }

        async function handleCreateTask(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('taskTitle').value,
                task_type: document.getElementById('taskType').value,
                description: document.getElementById('taskDescription').value,
                requirements: document.getElementById('taskRequirements').value,
                reward_amount: parseFloat(document.getElementById('rewardAmount').value),
                difficulty: document.getElementById('taskDifficulty').value,
                required_membership: document.getElementById('requiredMembership').value,
                deadline_days: parseInt(document.getElementById('deadlineDays').value),
                status: 'active',
                created_at: new Date().toISOString()
            };

            // Add transcription-specific fields
            if (formData.task_type === 'transcription') {
                formData.word_count_target = document.getElementById('wordCountTarget').value ? parseInt(document.getElementById('wordCountTarget').value) : null;
                formData.audio_duration = document.getElementById('audioDuration').value ? parseInt(document.getElementById('audioDuration').value) : null;
                formData.audio_url = document.getElementById('audioUrl').value || null;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .insert([formData])
                    .select();

                if (error) throw error;

                showMessage('‚úÖ Task created successfully! Users can now see this task with full description and requirements.', 'success');
                createTaskForm.reset();
                transcriptionFields.style.display = 'none';
                
                // Reload tasks
                await loadTasks();

            } catch (error) {
                console.error('Error creating task:', error);
                showMessage('‚ùå Failed to create task: ' + error.message, 'error');
            }
        }

        async function loadTasksForLinking() {
            try {
                const { data: tasks, error } = await supabaseClient
                    .from('tasks')
                    .select('id, title, task_type')
                    .eq('status', 'active')
                    .eq('task_type', 'transcription');

                if (error) throw error;

                taskSelect.innerHTML = '<option value="">Select a task</option>' +
                    (tasks || []).map(task => `
                        <option value="${task.id}">${task.title} (${formatTaskType(task.task_type)})</option>
                    `).join('');

            } catch (error) {
                console.error('Error loading tasks for linking:', error);
            }
        }

        async function handleLinkAudio(e) {
            e.preventDefault();
            
            const audioUrl = document.getElementById('audioUrlInput').value;
            const taskId = taskSelect.value;

            if (!audioUrl || !taskId) {
                showMessage('‚ùå Please provide both an audio URL and select a task', 'error');
                return;
            }

            // Update the task with audio URL
            try {
                const { error } = await supabaseClient
                    .from('tasks')
                    .update({
                        audio_url: audioUrl,
                        has_audio: true
                    })
                    .eq('id', taskId);

                if (error) throw error;

                showMessage('‚úÖ Audio URL linked to task successfully! Users can now access this audio.', 'success');
                linkAudioForm.reset();

            } catch (error) {
                console.error('Error linking audio:', error);
                showMessage('‚ùå Failed to link audio URL: ' + error.message, 'error');
            }
        }

        async function loadUsers() {
            try {
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allUsers = {};
                users.forEach(user => {
                    allUsers[user.id] = user;
                });

                renderAllUsers();

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersContainer').innerHTML = `
                    <div class="no-data">
                        <h3>Error loading users</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        function renderAllUsers() {
            const users = Object.values(allUsers);
            
            if (users.length === 0) {
                document.getElementById('usersContainer').innerHTML = `
                    <div class="no-data">
                        <h3>No users found</h3>
                        <p>Users will appear here once they register</p>
                    </div>
                `;
                return;
            }

            document.getElementById('usersContainer').innerHTML = users.map(user => `
                <div class="submission-card">
                    <div class="submission-header">
                        <div style="flex: 1;">
                            <div class="task-title">${user.full_name || 'No Name'}</div>
                            <div class="user-info">
                                <strong>Email:</strong> ${user.email} | 
                                <strong>Phone:</strong> ${user.phone || 'Not provided'} |
                                <strong>Member Since:</strong> ${new Date(user.created_at).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="reward-amount">
                            KSh ${(user.balance || 0).toLocaleString()}
                        </div>
                    </div>
                    <div class="user-contact">
                        <strong>üìä Statistics:</strong> 
                        ${user.tasks_completed || 0} tasks completed ‚Ä¢ 
                        KSh ${(user.total_earnings || 0).toLocaleString()} total earnings ‚Ä¢
                        ${user.role || 'starter'} membership
                    </div>
                </div>
            `).join('');
        }

        function renderTopEarners() {
            const users = Object.values(allUsers)
                .sort((a, b) => (b.total_earnings || 0) - (a.total_earnings || 0))
                .slice(0, 10);

            if (users.length === 0) {
                document.getElementById('usersContainer').innerHTML = `
                    <div class="no-data">
                        <h3>No users found</h3>
                        <p>Users will appear here once they complete tasks</p>
                    </div>
                `;
                return;
            }

            document.getElementById('usersContainer').innerHTML = users.map((user, index) => `
                <div class="submission-card">
                    <div class="submission-header">
                        <div style="flex: 1;">
                            <div class="task-title">
                                ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ'} 
                                ${user.full_name || 'No Name'}
                            </div>
                            <div class="user-info">
                                <strong>Rank:</strong> #${index + 1} | 
                                <strong>Email:</strong> ${user.email} |
                                <strong>Tasks Completed:</strong> ${user.tasks_completed || 0}
                            </div>
                        </div>
                        <div class="reward-amount">
                            KSh ${(user.total_earnings || 0).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentActivity() {
            // This would show recent user activity
            document.getElementById('usersContainer').innerHTML = `
                <div class="no-data">
                    <h3>Recent User Activity</h3>
                    <p>User activity tracking will be implemented here</p>
                </div>
            `;
        }

        // Helper functions
        function showMessage(message, type) {
            if (!messageContainer) return;
            
            messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    messageContainer.innerHTML = '';
                }, 5000);
            }
        }

        function formatTaskType(type) {
            const types = {
                'transcription': 'Audio Transcription',
                'academic_writing': 'Academic Writing',
                'academic_research': 'Academic Research',
                'content_writing': 'Content Writing',
                'data_entry': 'Data Entry'
            };
            return types[type] || type;
        }

        function formatDifficulty(difficulty) {
            if (!difficulty) return 'Unknown';
            return difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        }

        function formatAudioDuration(seconds) {
            if (!seconds) return 'Unknown';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function formatTimeTaken(seconds) {
            if (!seconds) return 'Not recorded';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function analyzeWordCount(text, targetCount) {
            // Handle object data
            if (typeof text === 'object' && text !== null) {
                if (text.content) {
                    text = text.content;
                } else if (text.transcription) {
                    text = text.transcription;
                } else {
                    text = JSON.stringify(text);
                }
            }
            
            const words = text.toString().trim().split(/\s+/).length;
            const characters = text.toString().length;
            const sentences = text.toString().split(/[.!?]+/).length - 1;
            const avgSentenceLength = sentences > 0 ? words / sentences : 0;
            
            let quality = 'good';
            let qualityColor = 'metric-good';
            
            if (targetCount) {
                const percentage = (words / targetCount) * 100;
                if (percentage < 80) {
                    quality = 'too short';
                    qualityColor = 'metric-danger';
                } else if (percentage > 120) {
                    quality = 'too long';
                    qualityColor = 'metric-warning';
                } else if (percentage >= 80 && percentage <= 120) {
                    quality = 'good';
                    qualityColor = 'metric-good';
                }
            }
            
            return {
                words,
                characters,
                sentences,
                avgSentenceLength,
                quality,
                qualityColor
            };
        }

        // Initialize with dashboard
        showSection('dashboard');
    </script>
</body>
</html>





