<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold Gain - Sign Up</title>
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      text-align: center; 
      margin: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f9d976, #f39f86);
    }
    .container { 
      width: 100%;
      max-width: 420px; 
      padding: 30px; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    input { 
      width: 90%; 
      padding: 12px; 
      margin: 10px 0; 
      border-radius: 10px; 
      border: 1px solid #ccc; 
      font-size: 14px;
    }
    button { 
      padding: 12px 25px; 
      background: gold; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    button:hover { 
      background: darkgoldenrod; 
      color: #fff; 
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    img { 
      max-width: 100%; 
      border-radius: 12px; 
      margin-bottom: 20px; 
    }
    p#message { 
      font-weight: bold; 
      margin-top: 10px; 
    }
    .spinner {
      display: none;
      margin: 10px auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid gold;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .required-field::after {
      content: " *";
      color: red;
    }
    .referral-note {
      font-size: 12px;
      color: #666;
      margin: -5px 0 10px 0;
      text-align: left;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
    }
    .referral-valid {
      border-color: #28a745 !important;
      background-color: #f8fff9;
    }
    .referral-invalid {
      border-color: #dc3545 !important;
      background-color: #fff8f8;
    }
    .default-code {
      font-size: 11px;
      color: #004aad;
      margin: -8px 0 10px 0;
      text-align: left;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <img src="https://images.unsplash.com/photo-1581092795367-6d0b7d1b2c68?auto=format&fit=crop&w=400&q=80" alt="Gold Gain Welcome">
  <h2>Sign Up for Gold Gain</h2>
  <form id="signup-form">
    <input type="text" id="fullName" placeholder="Full Name" required><br>
    <input type="email" id="email" placeholder="Email" required><br>
    <input type="password" id="password" placeholder="Password" required><br>
    <input type="password" id="confirm-password" placeholder="Confirm Password" required><br>
    
    <label for="referral" class="required-field" style="display: block; text-align: left; width: 90%; margin: 10px auto 5px; font-weight: bold;">Referral Code</label>
    <input type="text" id="referral" placeholder="Enter referral code" required><br>
    <div class="referral-note">You must have a referral code from an existing member to join</div>
    <div class="default-code">Default code: <strong>892692</strong> (Use this if you don't have one)</div>
    
    <input type="text" id="phone" placeholder="Phone Number" required><br>
    <button type="submit">Sign Up</button>
  </form>
  <div class="spinner" id="spinner"></div>
  <p id="message"></p>
  <p>Already a member? <a href="login.html">Login</a></p>
  <p style="font-size: 12px; color: #666; margin-top: 20px;">
    Don't have a referral code? Use the default code above or contact support.
  </p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  // Initialize Supabase client
  const SUPABASE_URL = "https://lfrjtklkbppihaaiuxef.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmcmp0a2xrYnBwaWhhYWl1eGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTI5MzMsImV4cCI6MjA3NDYyODkzM30.2FVqnt5daF2Tw-RmVBwOGgt4GuIQQSkG8IUZt30QxIM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Default referral code that always works
  const DEFAULT_REFERRAL_CODE = "892692";

  const form = document.getElementById("signup-form");
  const message = document.getElementById("message");
  const spinner = document.getElementById("spinner");
  const referralInput = document.getElementById("referral");

  // Set default referral code in the input field
  referralInput.value = DEFAULT_REFERRAL_CODE;
  referralInput.classList.add('referral-valid');

  // Real-time referral code validation
  let referralValidationTimeout;
  referralInput.addEventListener("input", function(e) {
    const value = e.target.value.trim();
    
    // Clear previous timeout
    clearTimeout(referralValidationTimeout);
    
    // Remove any special characters, keep only alphanumeric
    e.target.value = value.replace(/[^a-zA-Z0-9]/g, '');
    
    // Validate after user stops typing (500ms delay)
    if (value.length >= 3) {
      referralValidationTimeout = setTimeout(() => {
        validateReferralCode(value);
      }, 500);
    } else {
      // Reset styling if too short
      referralInput.classList.remove('referral-valid', 'referral-invalid');
    }
  });

  // Function to validate referral code against Supabase
  async function validateReferralCode(referralCode) {
    if (!referralCode || referralCode.length < 3) {
      referralInput.classList.remove('referral-valid', 'referral-invalid');
      return false;
    }

    // Always validate default code as true
    if (referralCode === DEFAULT_REFERRAL_CODE) {
      referralInput.classList.remove('referral-invalid');
      referralInput.classList.add('referral-valid');
      return true;
    }

    try {
      console.log('Validating referral code:', referralCode);
      
      // Query Supabase profiles table for the referral code
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('id, referral_code, full_name')
        .eq('referral_code', referralCode.toUpperCase())
        .single();

      if (error) {
        console.log('Referral validation error:', error);
        if (error.code === 'PGRST116') {
          referralInput.classList.remove('referral-valid');
          referralInput.classList.add('referral-invalid');
          return false;
        }
        throw error;
      }

      if (data) {
        console.log('Valid referral code found:', data);
        referralInput.classList.remove('referral-invalid');
        referralInput.classList.add('referral-valid');
        return true;
      } else {
        referralInput.classList.remove('referral-valid');
        referralInput.classList.add('referral-invalid');
        return false;
      }

    } catch (error) {
      console.error('Error validating referral code:', error);
      referralInput.classList.remove('referral-valid', 'referral-invalid');
      return false;
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const fullName = document.getElementById("fullName").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const referral = document.getElementById("referral").value.trim();
    const phone = document.getElementById("phone").value.trim();

    // Basic validation
    if (password !== confirmPassword) {
      message.style.color = "red";
      message.textContent = "Passwords do not match!";
      return;
    }

    if (!referral) {
      message.style.color = "red";
      message.textContent = "Referral code is required!";
      return;
    }

    // Validate referral code format
    const referralRegex = /^[a-zA-Z0-9]{3,20}$/;
    if (!referralRegex.test(referral)) {
      message.style.color = "red";
      message.textContent = "Invalid referral code format! Must be 3-20 alphanumeric characters.";
      return;
    }

    message.style.color = "black";
    message.textContent = "Creating your account...";
    spinner.style.display = "block";

    try {
      let referrerData = null;
      let isDefaultCode = false;

      // Step 1: Verify referral code exists in the system
      if (referral === DEFAULT_REFERRAL_CODE) {
        console.log('Using default referral code:', DEFAULT_REFERRAL_CODE);
        isDefaultCode = true;
        referrerData = {
          id: 'default-referrer',
          referral_code: DEFAULT_REFERRAL_CODE,
          full_name: 'System Default',
          email: 'system@default.com'
        };
      } else {
        console.log('Checking referral code in Supabase:', referral);
        const { data: referralData, error: referralError } = await supabaseClient
          .from("profiles")
          .select("id, referral_code, full_name, email")
          .eq("referral_code", referral.toUpperCase())
          .single();

        console.log('Referral check result:', referralData, referralError);

        if (referralError && referralError.code === 'PGRST116') {
          spinner.style.display = "none";
          message.style.color = "red";
          message.textContent = "Invalid referral code! This code does not exist in our system.";
          return;
        } else if (referralError) {
          throw referralError;
        }

        if (!referralData) {
          spinner.style.display = "none";
          message.style.color = "red";
          message.textContent = "Invalid referral code! Please check the code and try again.";
          return;
        }

        referrerData = referralData;
        console.log('Referrer found:', referrerData);
      }

      // Step 2: Check if user already exists before creating
      const { data: existingUser, error: existingError } = await supabaseClient
        .from('profiles')
        .select('id')
        .eq('email', email)
        .single();

      if (existingUser && !existingError) {
        spinner.style.display = "none";
        message.style.color = "red";
        message.textContent = "An account with this email already exists. Please login instead.";
        return;
      }

      // Step 3: Create account in Supabase Auth
      const { data: authData, error: authError } = await supabaseClient.auth.signUp({
        email, 
        password,
        options: {
          data: {
            full_name: fullName,
            phone: phone
          }
        }
      });

      if (authError) {
        spinner.style.display = "none";
        message.style.color = "red";
        message.textContent = "Auth Error: " + authError.message;
        return;
      }

      // Step 4: Insert profile details into "profiles" with UPSERT (insert or update)
      const user = authData.user;
      
      // Generate a unique referral code for the new user
      const userReferralCode = generateReferralCode(fullName, email);
      
      const profileData = {
        id: user.id,
        full_name: fullName,
        email: email,
        phone: phone,
        referral_code: userReferralCode,
        referred_by: referral.toUpperCase(),
        balance: 0,
        role: "user",
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      // Only add referrer_id if it's not the default code
      if (!isDefaultCode && referrerData.id !== 'default-referrer') {
        profileData.referrer_id = referrerData.id;
      }

      // Use UPSERT instead of INSERT to handle existing profiles
      const { error: profileError } = await supabaseClient
        .from("profiles")
        .upsert(profileData, {
          onConflict: 'id', // This handles the duplicate key issue
          ignoreDuplicates: false
        });

      if (profileError) {
        console.error('Profile upsert error:', profileError);
        
        // If it's a duplicate key error, try UPDATE instead
        if (profileError.code === '23505') {
          const { error: updateError } = await supabaseClient
            .from("profiles")
            .update(profileData)
            .eq('id', user.id);

          if (updateError) {
            throw updateError;
          }
        } else {
          throw profileError;
        }
      }

      // Step 5: Update referrer's referral count (only for non-default codes)
      if (!isDefaultCode && referrerData.id !== 'default-referrer') {
        try {
          const { error: updateError } = await supabaseClient
            .from("profiles")
            .update({ 
              referrals_count: supabaseClient.sql`COALESCE(referrals_count, 0) + 1`
            })
            .eq("id", referrerData.id);

          if (updateError) {
            console.log("Could not update referrer count:", updateError);
          }
        } catch (updateError) {
          console.log("Error updating referral count:", updateError);
        }
      }

      spinner.style.display = "none";
      message.style.color = "green";
      message.textContent = "âœ… Account created successfully! Please check your email to confirm your account.";
      form.reset();

      // Reset the referral field to default code
      setTimeout(() => {
        referralInput.value = DEFAULT_REFERRAL_CODE;
        referralInput.classList.add('referral-valid');
      }, 1000);

    } catch (error) {
      spinner.style.display = "none";
      message.style.color = "red";
      
      if (error.message?.includes('duplicate key') || error.code === '23505') {
        message.textContent = "Account already exists. Please try logging in or use a different email.";
      } else {
        message.textContent = "An unexpected error occurred. Please try again.";
      }
      
      console.error("Signup error:", error);
    }
  });

  // Function to generate a unique referral code
  function generateReferralCode(fullName, email) {
    const namePart = fullName.replace(/\s+/g, '').substring(0, 3).toUpperCase();
    const randomPart = Math.random().toString(36).substring(2, 5).toUpperCase();
    const emailPart = email.split('@')[0].substring(0, 2).toUpperCase();
    
    return namePart + randomPart + emailPart;
  }

  // Initialize the default code validation on page load
  document.addEventListener('DOMContentLoaded', function() {
    validateReferralCode(DEFAULT_REFERRAL_CODE);
  });
</script>

</body>
</html>
