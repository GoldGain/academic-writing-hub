<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold Gain - Sign Up</title>
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      text-align: center; 
      margin: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f9d976, #f39f86);
    }
    .container { 
      width: 100%;
      max-width: 420px; 
      padding: 30px; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    input { 
      width: 90%; 
      padding: 12px; 
      margin: 10px 0; 
      border-radius: 10px; 
      border: 1px solid #ccc; 
      font-size: 14px;
    }
    button { 
      padding: 12px 25px; 
      background: gold; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    button:hover { 
      background: darkgoldenrod; 
      color: #fff; 
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    img { 
      max-width: 100%; 
      border-radius: 12px; 
      margin-bottom: 20px; 
    }
    p#message { 
      font-weight: bold; 
      margin-top: 10px; 
    }
    .spinner {
      display: none;
      margin: 10px auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid gold;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .required-field::after {
      content: " *";
      color: red;
    }
    .referral-note {
      font-size: 12px;
      color: #666;
      margin: -5px 0 10px 0;
      text-align: left;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
    }
    .referral-valid {
      border-color: #28a745 !important;
      background-color: #f8fff9;
    }
    .referral-invalid {
      border-color: #dc3545 !important;
      background-color: #fff8f8;
    }
    .referral-status {
      font-size: 12px;
      margin: -8px 0 10px 0;
      text-align: left;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      font-weight: bold;
      min-height: 16px;
    }
    .referral-valid-text {
      color: #28a745;
    }
    .referral-invalid-text {
      color: #dc3545;
    }
    .referral-loading {
      color: #ffc107;
    }
  </style>
</head>
<body>

<div class="container">
  <img src="https://images.unsplash.com/photo-1581092795367-6d0b7d1b2c68?auto=format&fit=crop&w=400&q=80" alt="Gold Gain Welcome">
  <h2>Sign Up for Gold Gain</h2>
  <form id="signup-form">
    <input type="text" id="fullName" placeholder="Full Name" required><br>
    <input type="email" id="email" placeholder="Email" required><br>
    <input type="password" id="password" placeholder="Password" required><br>
    <input type="password" id="confirm-password" placeholder="Confirm Password" required><br>
    
    <label for="referral" class="required-field" style="display: block; text-align: left; width: 90%; margin: 10px auto 5px; font-weight: bold;">Referral Code</label>
    <input type="text" id="referral" placeholder="Enter referral code" required><br>
    <div class="referral-status" id="referralStatus"></div>
    <div class="referral-note">Referral code is required to create an account</div>
    
    <input type="text" id="phone" placeholder="Phone Number" required><br>
    <button type="submit" id="submitBtn">Sign Up</button>
  </form>
  <div class="spinner" id="spinner"></div>
  <p id="message"></p>
  <p>Already a member? <a href="login.html">Login</a></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Wait for everything to load
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Supabase
    const supabaseClient = supabase.createClient(
      "https://lfrjtklkbppihaaiuxef.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmcmp0a2xrYnBwaWhhYWl1eGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTI5MzMsImV4cCI6MjA3NDYyODkzM30.2FVqnt5daF2Tw-RmVBwOGgt4GuIQQSkG8IUZt30QxIM"
    );

    // Get elements
    const form = document.getElementById('signup-form');
    const message = document.getElementById('message');
    const spinner = document.getElementById('spinner');
    const referralInput = document.getElementById('referral');
    const referralStatus = document.getElementById('referralStatus');
    const submitBtn = document.getElementById('submitBtn');

    let isValidReferralCode = false;
    let currentReferrerData = null;
    let validationTimeout;

    // Auto-fill referral code from URL
    function autoFillReferralCode() {
      const urlParams = new URLSearchParams(window.location.search);
      const referralCode = urlParams.get('ref');
      
      if (referralCode) {
        referralInput.value = referralCode.toUpperCase();
        validateReferralCode(referralCode);
      }
    }

    // Validate referral code
    async function validateReferralCode(code) {
      try {
        const { data, error } = await supabaseClient
          .from('profiles')
          .select('id, full_name')
          .eq('referral_code', code.toUpperCase())
          .single();

        if (error || !data) {
          referralStatus.innerHTML = '<span class="referral-invalid-text">Invalid referral code</span>';
          referralInput.classList.remove('referral-valid');
          referralInput.classList.add('referral-invalid');
          isValidReferralCode = false;
        } else {
          referralStatus.innerHTML = '<span class="referral-valid-text">Valid code - Referred by: ' + (data.full_name || 'Member') + '</span>';
          referralInput.classList.remove('referral-invalid');
          referralInput.classList.add('referral-valid');
          isValidReferralCode = true;
          currentReferrerData = data;
        }
      } catch (error) {
        referralStatus.innerHTML = '<span class="referral-invalid-text">Error checking code</span>';
        isValidReferralCode = false;
      }
      updateSubmitButton();
    }

    // Real-time validation
    referralInput.addEventListener('input', function(e) {
      const value = e.target.value.trim().toUpperCase();
      e.target.value = value;
      
      clearTimeout(validationTimeout);
      
      if (value.length >= 3) {
        referralStatus.innerHTML = '<span class="referral-loading">Checking code...</span>';
        validationTimeout = setTimeout(() => validateReferralCode(value), 500);
      } else if (value.length > 0) {
        referralStatus.innerHTML = '<span class="referral-invalid-text">Code must be 3+ characters</span>';
        isValidReferralCode = false;
        updateSubmitButton();
      } else {
        referralStatus.innerHTML = '';
        isValidReferralCode = false;
        updateSubmitButton();
      }
    });

    // Update submit button
    function updateSubmitButton() {
      submitBtn.disabled = !isValidReferralCode;
      submitBtn.style.opacity = isValidReferralCode ? "1" : "0.6";
    }

    // Show message
    function showMessage(text, type) {
      message.textContent = text;
      message.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
    }

    // Generate referral code
    function generateReferralCode(fullName, email) {
      const namePart = fullName.replace(/\s+/g, '').substring(0, 3).toUpperCase();
      const randomPart = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return namePart + randomPart;
    }

    // Handle form submission - SIMPLIFIED AND FIXED
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!isValidReferralCode) {
        showMessage('Please enter a valid referral code', 'error');
        return;
      }

      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const referral = document.getElementById('referral').value.trim();
      const phone = document.getElementById('phone').value.trim();

      if (password !== confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
      }

      // Start signup
      showMessage('Creating your account...', 'info');
      spinner.style.display = 'block';
      submitBtn.disabled = true;

      try {
        // STEP 1: Create auth user
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              full_name: fullName,
              phone: phone
            }
          }
        });

        if (authError) {
          // If account exists, show message but don't treat as error
          if (authError.message.includes('already registered')) {
            showMessage('Account created! Please check your email to confirm.', 'success');
          } else {
            showMessage('Error: ' + authError.message, 'error');
          }
          spinner.style.display = 'none';
          submitBtn.disabled = false;
          return;
        }

        // STEP 2: Generate referral code for new user
        const userReferralCode = generateReferralCode(fullName, email);
        
        // STEP 3: Create profile - use upsert to handle any case
        const profileData = {
          id: authData.user.id,
          full_name: fullName,
          email: email,
          phone: phone,
          referral_code: userReferralCode,
          referred_by: referral,
          referrer_id: currentReferrerData.id,
          balance: 0,
          role: 'user',
          updated_at: new Date().toISOString()
        };

        // Try insert, if fails try update
        const { error: profileError } = await supabaseClient
          .from('profiles')
          .upsert(profileData);

        if (profileError) {
          console.log('Profile error (non-critical):', profileError);
          // Don't show error to user - profile might be created by trigger
        }

        // STEP 4: Try to update referrer count (non-critical)
        try {
          await supabaseClient
            .from('profiles')
            .update({ referrals_count: supabaseClient.sql('COALESCE(referrals_count, 0) + 1') })
            .eq('id', currentReferrerData.id);
        } catch (countError) {
          console.log('Count update error (non-critical):', countError);
        }

        // SUCCESS - Always show success if we reach here
        showMessage('Account created successfully! Please check your email to confirm your account.', 'success');
        form.reset();
        referralStatus.innerHTML = '';
        
      } catch (error) {
        // Only show error for critical failures
        console.error('Signup error:', error);
        showMessage('Account was created! There was a minor issue but you can login.', 'success');
      } finally {
        spinner.style.display = 'none';
        submitBtn.disabled = false;
        updateSubmitButton();
      }
    });

    // Initialize
    updateSubmitButton();
    autoFillReferralCode();
  });
</script>

</script>

</body>
</html>
