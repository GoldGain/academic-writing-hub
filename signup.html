<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - Gold Gain</title>
  <!-- PWA Meta Tags -->
<meta name="theme-color" content="#b8860b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Gold Gain">
<meta name="mobile-web-app-capable" content="yes">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<!-- Icons -->
<link rel="icon" href="icons/icon-192x192.png">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <style>
    :root {
      --primary: #004aad;
      --primary-light: #3a6fc8;
      --secondary: #ff6b35;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border: #e9ecef;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f4f6f9 0%, #e9ecef 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 40px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: rotate(45deg);
    }

    .logo {
      width: 90px;
      height: 90px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #ffd700, #ff6b35);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: bold;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      border: 4px solid white;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      opacity: 0.95;
      font-size: 16px;
      font-weight: 500;
    }

    .form-container {
      padding: 40px;
    }

    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--dark);
      font-size: 15px;
    }

    .required-field::after {
      content: " *";
      color: var(--danger);
    }

    .form-input {
      width: 100%;
      padding: 16px 18px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #fff;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0, 74, 173, 0.15);
      transform: translateY(-2px);
    }

    .referral-valid {
      border-color: var(--success) !important;
      background-color: #f8fff9;
    }

    .referral-invalid {
      border-color: var(--danger) !important;
      background-color: #fff8f8;
    }

    .referral-status {
      font-size: 14px;
      margin: 10px 0;
      font-weight: 600;
      min-height: 20px;
    }

    .referral-valid-text {
      color: var(--success);
    }

    .referral-invalid-text {
      color: var(--danger);
    }

    .referral-loading {
      color: var(--warning);
    }

    .referral-note {
      font-size: 13px;
      color: var(--gray);
      margin-top: 8px;
      line-height: 1.5;
    }

    .submit-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
      letter-spacing: 0.5px;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(0, 74, 173, 0.4);
    }

    .submit-btn:active {
      transform: translateY(-1px);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .spinner {
      display: none;
      margin: 20px auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .message {
      padding: 16px 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
    }

    .message.success {
      background: #e8f5e9;
      color: var(--success);
      border: 2px solid #c8e6c9;
    }

    .message.error {
      background: #ffebee;
      color: var(--danger);
      border: 2px solid #ffcdd2;
    }

    .message.info {
      background: #e3f2fd;
      color: var(--primary);
      border: 2px solid #bbdefb;
    }

    .login-link {
      text-align: center;
      margin-top: 30px;
      color: var(--gray);
      font-size: 15px;
    }

    .login-link a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .login-link a:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    .verification-note {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border: 2px solid #ffd54f;
      border-radius: 12px;
      padding: 20px;
      margin: 25px 0;
      text-align: center;
      font-size: 14px;
      color: #856404;
      font-weight: 600;
    }

    .verification-note strong {
      color: var(--primary);
      font-size: 15px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        align-items: flex-start;
      }

      .container {
        max-width: 100%;
        margin-top: 20px;
      }

      .header {
        padding: 30px 20px;
      }

      .header h1 {
        font-size: 28px;
      }

      .logo {
        width: 80px;
        height: 80px;
        font-size: 32px;
      }

      .form-container {
        padding: 30px 25px;
      }

      .form-input {
        padding: 14px 16px;
      }

      .submit-btn {
        padding: 16px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 25px 15px;
      }

      .header h1 {
        font-size: 26px;
      }

      .logo {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }

      .form-container {
        padding: 25px 20px;
      }

      .header p {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">💰</div>
    <h1>Join Gold Gain</h1>
    <p>Start Your Journey to Financial Freedom</p>
  </div>

  <div class="form-container">
    <div class="verification-note">
      <strong>📧 Email Verification Required</strong><br>
      Verify your email to activate your account and start earning
    </div>

    <form id="signup-form">
      <div class="form-group">
        <label for="fullName" class="required-field">Full Name</label>
        <input type="text" id="fullName" class="form-input" placeholder="Your full name" required>
      </div>

      <div class="form-group">
        <label for="email" class="required-field">Email Address</label>
        <input type="email" id="email" class="form-input" placeholder="Your email address" required>
      </div>

      <div class="form-group">
        <label for="password" class="required-field">Password</label>
        <input type="password" id="password" class="form-input" placeholder="Your password" required>
      </div>

      <div class="form-group">
        <label for="confirm-password" class="required-field">Confirm Password</label>
        <input type="password" id="confirm-password" class="form-input" placeholder="Confirm your password" required>
      </div>

      <div class="form-group">
        <label for="referral" class="required-field">Referral Code</label>
        <input type="text" id="referral" class="form-input" placeholder="Referral code" required>
        <div class="referral-status" id="referralStatus"></div>
        <div class="referral-note">Enter the referral code provided by your inviter</div>
      </div>

      <div class="form-group">
        <label for="phone" class="required-field">Phone Number</label>
        <input type="text" id="phone" class="form-input" placeholder="Your phone number" required>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">Create Account</button>
    </form>

    <div class="spinner" id="spinner"></div>
    <div id="message"></div>

    <div class="login-link">
      Already have an account? <a href="login.html">Sign In Here</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const supabaseClient = supabase.createClient(
      "https://lfrjtklkbppihaaiuxef.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxmcmp0a2xrYnBwaWhhYWl1eGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTI5MzMsImV4cCI6MjA3NDYyODkzM30.2FVqnt5daF2Tw-RmVBwOGgt4GuIQQSkG8IUZt30QxIM"
    );

    const form = document.getElementById('signup-form');
    const message = document.getElementById('message');
    const spinner = document.getElementById('spinner');
    const referralInput = document.getElementById('referral');
    const referralStatus = document.getElementById('referralStatus');
    const submitBtn = document.getElementById('submitBtn');

    let isValidReferralCode = false;
    let currentReferrerData = null;
    let validationTimeout;

    // Auto-fill referral code from URL - IMPROVED VERSION
    function autoFillReferralCode() {
      const urlParams = new URLSearchParams(window.location.search);
      const referralCode = urlParams.get('ref');
      
      if (referralCode) {
        referralInput.value = referralCode.toUpperCase();
        validateReferralCode(referralCode);
        
        // Show success message for auto-filled code
        setTimeout(() => {
          if (isValidReferralCode) {
            showMessage('✅ Referral code auto-filled successfully!', 'success');
          }
        }, 1000);
      }
    }

    // Validate referral code
    async function validateReferralCode(code) {
      try {
        const { data, error } = await supabaseClient
          .from('profiles')
          .select('id, full_name')
          .eq('referral_code', code.toUpperCase())
          .single();

        if (error || !data) {
          referralStatus.innerHTML = '<span class="referral-invalid-text">❌ Invalid referral code</span>';
          referralInput.classList.remove('referral-valid');
          referralInput.classList.add('referral-invalid');
          isValidReferralCode = false;
        } else {
          referralStatus.innerHTML = '<span class="referral-valid-text">✅ Valid code - Referred by: ' + (data.full_name || 'Member') + '</span>';
          referralInput.classList.remove('referral-invalid');
          referralInput.classList.add('referral-valid');
          isValidReferralCode = true;
          currentReferrerData = data;
        }
      } catch (error) {
        referralStatus.innerHTML = '<span class="referral-invalid-text">❌ Error checking code</span>';
        isValidReferralCode = false;
      }
      updateSubmitButton();
    }

    // Real-time validation
    referralInput.addEventListener('input', function(e) {
      const value = e.target.value.trim().toUpperCase();
      e.target.value = value;
      
      clearTimeout(validationTimeout);
      
      if (value.length >= 3) {
        referralStatus.innerHTML = '<span class="referral-loading">⏳ Checking code...</span>';
        validationTimeout = setTimeout(() => validateReferralCode(value), 500);
      } else if (value.length > 0) {
        referralStatus.innerHTML = '<span class="referral-invalid-text">❌ Code must be 3+ characters</span>';
        isValidReferralCode = false;
        updateSubmitButton();
      } else {
        referralStatus.innerHTML = '';
        isValidReferralCode = false;
        updateSubmitButton();
      }
    });

    // Update submit button
    function updateSubmitButton() {
      submitBtn.disabled = !isValidReferralCode;
    }

    // Show message
    function showMessage(text, type) {
      message.innerHTML = '<div class="message ' + type + '">' + text + '</div>';
    }

    // Generate referral code
    function generateReferralCode(fullName, email) {
      const namePart = fullName.replace(/\s+/g, '').substring(0, 3).toUpperCase();
      const randomPart = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return namePart + randomPart;
    }

    // Handle form submission
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!isValidReferralCode) {
        showMessage('Please enter a valid referral code', 'error');
        return;
      }

      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const referral = document.getElementById('referral').value.trim();
      const phone = document.getElementById('phone').value.trim();

      if (!fullName || !email || !password || !confirmPassword || !referral || !phone) {
        showMessage('Please fill in all required fields', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
      }

      if (password.length < 6) {
        showMessage('Password must be at least 6 characters long', 'error');
        return;
      }

      // Start signup
      showMessage('Creating your account...', 'info');
      spinner.style.display = 'block';
      submitBtn.disabled = true;

      try {
        // Create auth user with email confirmation
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              full_name: fullName,
              phone: phone
            }
          }
        });

        if (authError) {
          if (authError.message.includes('already registered')) {
            showMessage('This email is already registered. Please sign in instead.', 'error');
          } else {
            showMessage('Error: ' + authError.message, 'error');
          }
          spinner.style.display = 'none';
          submitBtn.disabled = false;
          return;
        }

        // Generate referral code for new user
        const userReferralCode = generateReferralCode(fullName, email);
        
        // Create profile
        const profileData = {
          id: authData.user.id,
          full_name: fullName,
          email: email,
          phone: phone,
          referral_code: userReferralCode,
          referred_by: referral,
          referrer_id: currentReferrerData.id,
          balance: 0,
          role: 'user',
          updated_at: new Date().toISOString()
        };

        const { error: profileError } = await supabaseClient
          .from('profiles')
          .upsert(profileData);

        if (profileError) {
          console.log('Profile error:', profileError);
        }

        // Update referrer count
        try {
          await supabaseClient.rpc('increment_referral_count', { referrer_id: currentReferrerData.id });
        } catch (countError) {
          console.log('Count update error:', countError);
        }

        // SUCCESS
        showMessage('🎉 Account created successfully! Please check your email to verify your account before signing in.', 'success');
        form.reset();
        referralStatus.innerHTML = '';
        
      } catch (error) {
        console.error('Signup error:', error);
        showMessage('An error occurred during signup. Please try again.', 'error');
      } finally {
        spinner.style.display = 'none';
        submitBtn.disabled = false;
        updateSubmitButton();
      }
    });

    // Initialize
    updateSubmitButton();
    autoFillReferralCode();
  });
</script>
<script>
// PWA Installation
let deferredPrompt;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (installBtn) installBtn.style.display = 'block';
});

if (installBtn) {
  installBtn.addEventListener('click', async () => {
    installBtn.style.display = 'none';
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
  });
}

// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js');
  });
}
</script>

</body>
</html>
